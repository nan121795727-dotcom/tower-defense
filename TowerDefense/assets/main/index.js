System.register("chunks:///_virtual/Bullet.ts",["./rollupPluginModLoBabelHelpers.js","cc","./Enemy.ts","./GameConfig.ts","./TowerType.ts","./TouchManager.ts"],(function(t){var e,a,i,n,o,r,s,l,c,h,u;return{setters:[function(t){e=t.inheritsLoose},function(t){a=t.cclegacy,i=t._decorator,n=t.v3,o=t.Vec3,r=t.find,s=t.Component},function(t){l=t.Enemy},function(t){c=t.GameConfig},function(t){h=t.SkillType},function(t){u=t.TouchManager}],execute:function(){var f;a._RF.push({},"0edb43CQZ5FwoUCAtBQQ4rv","Bullet",void 0);var p=i.ccclass;i.property,t("Bullet",p("Bullet")(f=function(t){function a(){for(var e,a=arguments.length,i=new Array(a),n=0;n<a;n++)i[n]=arguments[n];return(e=t.call.apply(t,[this].concat(i))||this).damage=c.TOWER_BASE_DAMAGE,e.target=null,e.speed=c.BULLET_SPEED,e.towerData=null,e.towerLevel=1,e}e(a,t);var i=a.prototype;return i.setTarget=function(t){this.target=t},i.update=function(t){if(u.isGameOver)this.node.destroy();else if(this.target&&this.target.isValid){var e=this.node.getPosition(),a=this.target.getPosition(),i=n();o.subtract(i,a,e),i.length()<c.BULLET_HIT_DISTANCE?(this.onHit(this.target),this.node.destroy()):(i.normalize(),this.node.setPosition(e.add(i.multiplyScalar(this.speed*t))))}else this.node.destroy()},i.onHit=function(t){if(!u.isGameOver){var e=t.getComponent(l);if(e){var a=Math.floor(this.damage);if(e.takeDamage(a),this.towerData){var i=this.towerData.skillType,n=this.towerData.skillValue;switch(i){case h.SLOW:this.applySlow(t,n);break;case h.SPLASH:this.applySplash(t,n);break;case h.CHAIN:this.applyChain(t,n)}}}}},i.applySlow=function(t,e){var a=t.getComponent(l);a&&a.applySlow(e,3)},i.applySplash=function(t,e){var a=r("Canvas");if(a){var i=t.getPosition(),n=Math.floor(this.damage*e);a.children.forEach((function(e){if("Enemy"===e.name&&e!==t&&e.isValid&&o.distance(i,e.getPosition())<=80){var a=e.getComponent(l);a&&a.takeDamage(n)}}))}},i.applyChain=function(t,e){var a=r("Canvas");if(a)for(var i=t,n=Math.floor(.8*this.damage),s=function(){if(!i||!i.isValid)return 0;var t=i.getPosition(),e=null,r=150;if(a.children.forEach((function(a){if("Enemy"===a.name&&a!==i&&a.isValid){var n=o.distance(t,a.getPosition());n<r&&(r=n,e=a)}})),!e)return 0;var s=e.getComponent(l);s&&s.takeDamage(n),i=e,n=Math.floor(.8*n)},c=0;c<e&&0!==s();c++);},a}(s))||f);a._RF.pop()}}}));

System.register("chunks:///_virtual/DragDropSystem.ts",["./rollupPluginModLoBabelHelpers.js","cc","./TileSlot.ts","./Tower.ts","./TouchManager.ts","./WaveSystem.ts","./ShopSystem.ts","./ShopCard.ts"],(function(e){var i,t,o,n,r,s,a,l,g,h,c,d,u,v,w,T,p,f,C,P,m,x,b,y,S,D;return{setters:[function(e){i=e.applyDecoratedDescriptor,t=e.inheritsLoose,o=e.initializerDefineProperty,n=e.assertThisInitialized,r=e.createForOfIteratorHelperLoose},function(e){s=e.cclegacy,a=e._decorator,l=e.Prefab,g=e.Node,h=e.find,c=e.Camera,d=e.UITransform,u=e.Graphics,v=e.Color,w=e.instantiate,T=e.Sprite,p=e.v3,f=e.Vec3,C=e.Component},function(e){P=e.TileType,m=e.TileSlot},function(e){x=e.Tower},function(e){b=e.TouchManager},function(e){y=e.WaveSystem},function(e){S=e.ShopSystem},function(e){D=e.ShopCard}],execute:function(){var I,M,O,H,A,V,B;s._RF.push({},"95fc0OOskFODK94Cu1wfXu9","DragDropSystem",void 0);var E=a.ccclass,L=a.property;e("DragDropSystem",(I=E("DragDropSystem"),M=L(l),O=L(g),I((V=i((A=function(e){function i(){for(var i,t=arguments.length,r=new Array(t),s=0;s<t;s++)r[s]=arguments[s];return i=e.call.apply(e,[this].concat(r))||this,o(i,"towerPrefab",V,n(i)),o(i,"cancelArea",B,n(i)),i.draggingCard=null,i.draggingTower=null,i.dragTowerData=null,i.canvas=null,i.gridMap=null,i.shopPanel=null,i.waveSystem=null,i.mainCamera=null,i.rangeCircle=null,i.selectionBox=null,i.towerHighlight=null,i.longPressTimer=0,i.isLongPressing=!1,i.longPressTarget=null,i.LONG_PRESS_DURATION=.3,i}t(i,e);var s=i.prototype;return s.start=function(){var e,i,t;this.canvas=h("Canvas"),this.gridMap=h("Canvas/GridMap"),this.shopPanel=h("Canvas/ShopPanel"),this.waveSystem=(null==(e=h("Canvas"))?void 0:e.getComponentInChildren(y))||null,this.mainCamera=(null==(i=h("Canvas/Camera"))?void 0:i.getComponent(c))||(null==(t=h("Main Camera"))?void 0:t.getComponent(c))||null,this.canvas&&(this.canvas.on(g.EventType.TOUCH_START,this.onTouchStart,this),this.canvas.on(g.EventType.TOUCH_MOVE,this.onTouchMove,this),this.canvas.on(g.EventType.TOUCH_END,this.onTouchEnd,this),this.canvas.on(g.EventType.TOUCH_CANCEL,this.onTouchEnd,this)),this.createVisualNodes()},s.update=function(e){b.isGameOver?this.cleanupOnGameOver():this.isLongPressing&&this.longPressTarget&&(this.longPressTimer+=e,this.longPressTimer>=this.LONG_PRESS_DURATION&&(this.showTowerRange(this.longPressTarget),this.isLongPressing=!1))},s.cleanupOnGameOver=function(){if(this.draggingTower){if(this.draggingCard){var e=this.draggingCard.getComponent(D);e&&e.resetPurchaseState()}this.draggingTower.isValid&&this.draggingTower.destroy(),this.draggingTower=null,this.dragTowerData=null,this.draggingCard=null}if(this.draggingPlacedTower){var i=this.draggingPlacedTower,t=this.originalTowerPosition;i&&i.isValid&&t&&(i.setPosition(t),this.restoreTowerSiblingIndex(i)),this.draggingPlacedTower=null,this.originalTowerPosition=null,this.originalTowerTile=null}this.hideAllVisuals(),this.isLongPressing=!1,this.longPressTimer=0,this.longPressTarget=null},s.createVisualNodes=function(){if(this.canvas){this.rangeCircle=new g("RangeCircle"),this.canvas.addChild(this.rangeCircle),this.rangeCircle.addComponent(d).setContentSize(500,500);this.rangeCircle.addComponent(u);this.rangeCircle.active=!1,this.selectionBox=new g("SelectionBox"),this.canvas.addChild(this.selectionBox),this.selectionBox.addComponent(d).setContentSize(80,80);this.selectionBox.addComponent(u);this.selectionBox.active=!1,this.towerHighlight=new g("TowerHighlight"),this.canvas.addChild(this.towerHighlight),this.towerHighlight.addComponent(d).setContentSize(100,100);this.towerHighlight.addComponent(u);this.towerHighlight.active=!1}},s.updateVisualsZIndex=function(){var e=h("Canvas/GridMap"),i=e?e.getSiblingIndex():10;this.rangeCircle&&this.rangeCircle.active&&this.rangeCircle.setSiblingIndex(i+1),this.selectionBox&&this.selectionBox.active&&this.selectionBox.setSiblingIndex(i+3),this.towerHighlight&&this.towerHighlight.active&&this.towerHighlight.setSiblingIndex(i+3)},s.ensurePreviewOnTop=function(){if(this.canvas){this.draggingTower&&this.draggingTower.isValid&&this.draggingTower.setSiblingIndex(9999),this.draggingPlacedTower&&this.draggingPlacedTower.isValid&&this.draggingPlacedTower.setSiblingIndex(9999)}},s.drawRangeCircle=function(e,i){if(void 0===i&&(i=new v(0,255,100,40)),this.rangeCircle&&this.rangeCircle.isValid||(this.createVisualNodes(),this.rangeCircle)){var t=this.rangeCircle.getComponent(u);if(t){t.clear(),t.fillColor=i,t.circle(0,0,e),t.fill(),t.strokeColor=new v(i.r,i.g,i.b,200),t.lineWidth=2,t.circle(0,0,e),t.stroke(),t.strokeColor=new v(i.r,i.g,i.b,100),t.lineWidth=1,t.circle(0,0,e-5),t.stroke();var o=this.rangeCircle.getComponent(d);o&&o.setContentSize(2*e+10,2*e+10)}else this.rangeCircle.addComponent(u)}},s.drawSelectionBox=function(e){if(this.selectionBox&&this.selectionBox.isValid||(this.createVisualNodes(),this.selectionBox)){var i=this.selectionBox.getComponent(u);if(i){i.clear();var t=70,o=e?new v(100,255,100,80):new v(255,50,50,80),n=e?new v(100,255,100,255):new v(255,50,50,255);i.fillColor=o,i.roundRect(-35,-35,t,t,12),i.fill(),i.strokeColor=n,i.lineWidth=4,i.roundRect(-35,-35,t,t,12),i.stroke();var r=35;i.strokeColor=new v(255,255,255,200),i.lineWidth=2,i.moveTo(-35,-20),i.lineTo(-35,-35),i.lineTo(-20,-35),i.stroke(),i.moveTo(20,-35),i.lineTo(r,-35),i.lineTo(r,-20),i.stroke(),i.moveTo(r,20),i.lineTo(r,r),i.lineTo(20,r),i.stroke(),i.moveTo(-20,r),i.lineTo(-35,r),i.lineTo(-35,20),i.stroke()}else this.selectionBox.addComponent(u)}},s.drawTowerHighlight=function(e){if(this.towerHighlight&&this.towerHighlight.isValid||(this.createVisualNodes(),this.towerHighlight)){var i=this.towerHighlight.getComponent(u);if(i){i.clear();var t=e?new v(255,215,0,50):new v(255,50,50,50),o=e?new v(255,215,0,255):new v(255,50,50,255);i.fillColor=t,i.circle(0,0,38),i.fill(),i.strokeColor=o,i.lineWidth=2,i.circle(0,0,38),i.stroke()}else this.towerHighlight.addComponent(u)}},s.showTowerRange=function(e){var i=e.getComponent(x);if(i&&this.rangeCircle){var t=i.range||250;this.drawRangeCircle(t);var o=e.getPosition();this.rangeCircle.setPosition(o);var n=h("Canvas/GridMap");n&&this.rangeCircle.setSiblingIndex(n.getSiblingIndex()+1),this.rangeCircle.active=!0}},s.hideAllVisuals=function(){this.rangeCircle&&(this.rangeCircle.active=!1),this.selectionBox&&(this.selectionBox.active=!1),this.towerHighlight&&(this.towerHighlight.active=!1)},s.startDrag=function(e,i){if(this.waveSystem&&this.waveSystem.isInPreparePhase());else if(b.isGameOver)return;if(b.money<i.baseCost)console.log("金币不足，无法拖拽");else{if(!this.towerPrefab){var t,o=null==(t=h("Canvas"))?void 0:t.getComponentInChildren(b);if(!o||!o.towerPrefab)return void console.error("towerPrefab未设置");this.towerPrefab=o.towerPrefab}if(this.draggingCard=e,this.dragTowerData=i,this.createDragPreview(i),this.drawRangeCircle(i.baseRange),this.rangeCircle){this.rangeCircle.active=!0;var n=h("Canvas/GridMap");n&&this.rangeCircle.setSiblingIndex(n.getSiblingIndex()+1)}console.log("开始拖拽: "+i.name+", draggingCard: "+(this.draggingCard?this.draggingCard.name:"null"))}},s.createDragPreview=function(e){if(this.canvas&&this.towerPrefab){var i=w(this.towerPrefab);this.canvas.addChild(i),i.name="DragPreview";var t=this.canvas.children.length;i.setSiblingIndex(t+100);var o=i.getComponent(d);o&&(o.anchorX=.5,o.anchorY=.5);var n=i.getComponent(T);n&&(n.color=new v(255,255,255,150));var r=i.getComponent(x);r&&e&&(r.setPreviewMode(!0),r.init(e),r.enabled=!1),this.draggingTower=i}},s.convertUIToWorld=function(e){if(!this.canvas)return e;var i=this.canvas.getComponent(d);if(!i)return e;var t=i.contentSize,o=e.x-t.width/2,n=e.y-t.height/2;return p(o,n,0)},s.onTouchStart=function(e){if(!b.isGameOver&&!this.draggingTower&&!this.dragTowerData){var i=e.getUILocation(),t=this.convertUIToWorld(p(i.x,i.y,0));if(this.shopPanel){var o=this.shopPanel.getComponent(d);if(o){var n=this.shopPanel.getPosition(),r=o.contentSize;if(Math.abs(t.x-n.x)<r.width/2&&Math.abs(t.y-n.y)<r.height/2)return}}var s=this.getTowerAtPos(t);if(s){this.isLongPressing=!0,this.longPressTimer=0,this.longPressTarget=s;var a=s.getComponent(x);a&&1===a.level&&(console.log("开始拖拽已放置的防御塔: "+s.name+", 位置: ("+t.x.toFixed(1)+", "+t.y.toFixed(1)+")"),this.draggingPlacedTower=s,this.originalTowerPos=s.getPosition().clone(),s.setSiblingIndex(999),this.showTowerRange(s))}else;}},s.onTouchMove=function(e){if(!b.isGameOver&&(this.isLongPressing&&(this.isLongPressing=!1,this.longPressTarget=null),this.draggingTower||this.draggingPlacedTower)){var i=e.getUILocation(),t=this.convertUIToWorld(p(i.x,i.y,0)),o=this.getNearestTile(t),n=this.getTowerAtPosExcluding(t,this.draggingTower||this.draggingPlacedTower);if(this.draggingTower&&this.dragTowerData){var r=t;if(n)r=n.getPosition().clone();else if(o){var s=o.node.getPosition();r=p(s.x,s.y+20,s.z)}if(this.draggingTower.setPosition(r),this.rangeCircle&&this.rangeCircle.active&&this.rangeCircle.setPosition(p(r.x,r.y-20,r.z)),this.cancelArea&&this.isInCancelArea(t)){var a=this.draggingTower.getComponent(T);a&&(a.color=new v(255,100,100,150)),this.hideAllVisuals()}else{var l=this.draggingTower.getComponent(T);l&&(l.color=new v(255,255,255,150)),this.updateDragVisuals(o,n)}this.ensurePreviewOnTop()}if(this.draggingPlacedTower){var g=t;if(n)g=n.getPosition().clone();else if(o){var h=o.node.getPosition();g=p(h.x,h.y+20,h.z)}this.draggingPlacedTower.setPosition(g),this.rangeCircle&&this.rangeCircle.active&&this.rangeCircle.setPosition(p(g.x,g.y-20,g.z)),this.updatePlacedTowerDragVisuals(o,n),this.ensurePreviewOnTop()}}},s.updateDragVisuals=function(e,i){if(this.dragTowerData){if(i){var t,o=i.getComponent(x),n=null==(t=this.draggingTower)?void 0:t.getComponent(x),r=o&&n&&o.canAbsorb(n);this.drawTowerHighlight(r),this.towerHighlight&&(this.towerHighlight.setPosition(i.getPosition()),this.towerHighlight.active=!0),this.selectionBox&&(this.selectionBox.active=!1)}else if(e){var s=e.script.type===P.EMPTY&&!e.script.isOccupied;this.drawSelectionBox(s),this.selectionBox&&(this.selectionBox.setPosition(e.node.getPosition()),this.selectionBox.active=!0),this.towerHighlight&&(this.towerHighlight.active=!1)}else this.selectionBox&&(this.selectionBox.active=!1),this.towerHighlight&&(this.towerHighlight.active=!1);this.updateVisualsZIndex(),this.ensurePreviewOnTop()}},s.updatePlacedTowerDragVisuals=function(e,i){var t,o=null==(t=this.draggingPlacedTower)?void 0:t.getComponent(x);if(o){if(i){var n=i.getComponent(x),r=n&&n.canAbsorb(o);this.drawTowerHighlight(r),this.towerHighlight&&(this.towerHighlight.setPosition(i.getPosition()),this.towerHighlight.active=!0),this.selectionBox&&(this.selectionBox.active=!1)}else if(e){var s=e.script.type===P.EMPTY&&!e.script.isOccupied;this.drawSelectionBox(s),this.selectionBox&&(this.selectionBox.setPosition(e.node.getPosition()),this.selectionBox.active=!0),this.towerHighlight&&(this.towerHighlight.active=!1)}else this.selectionBox&&(this.selectionBox.active=!1),this.towerHighlight&&(this.towerHighlight.active=!1);this.updateVisualsZIndex(),this.ensurePreviewOnTop()}},s.getNearestTile=function(e){if(this.gridMap||(this.gridMap=h("Canvas/GridMap")),!this.gridMap)return null;for(var i,t=null,o=60,n=r(this.gridMap.children);!(i=n()).done;){var s=i.value,a=s.getPosition(),l=f.distance(e,a);if(l<o){var g=s.getComponent(m);g&&(o=l,t={node:s,script:g})}}return t},s.getTowerAtPosExcluding=function(e,i){if(!this.canvas)return null;var t=null,o=60,n=function n(r){if(r!==i&&"DragPreview"!==r.name&&r.isValid){if(r.getComponent(x)){var s=r.getPosition(),a=f.distance(s,e);a<o&&(o=a,t=r)}r.children.forEach((function(e){return n(e)}))}};return this.canvas.children.forEach((function(e){return n(e)})),t},s.onTouchEnd=function(e){if(this.isLongPressing=!1,this.longPressTarget=null,b.isGameOver)this.hideAllVisuals();else{var i=e.getUILocation(),t=this.convertUIToWorld(p(i.x,i.y,0));if(console.log("触摸结束，位置: ("+t.x.toFixed(1)+", "+t.y.toFixed(1)+")"),this.draggingTower&&this.dragTowerData){if(console.log("正在处理拖拽放置: "+this.dragTowerData.name),this.cancelArea&&this.isInCancelArea(t))return console.log("在取消区域，取消操作"),void this.clearDrag();var o=this.getTileAtPos(t);if(o){var n=o.node,r=o.script,s=this.getTowerOnTile(n.getPosition());if(s)if(s===this.draggingTower||"DragPreview"===s.name)console.log("检测到的是拖拽预览，跳过合成逻辑");else{var a,l=s.getComponent(x),g=null==(a=this.draggingTower)?void 0:a.getComponent(x);if(l&&g&&l.canAbsorb(g))if(b.money>=this.dragTowerData.baseCost){if(console.log("从商店合成到已放置防御塔: "+this.dragTowerData.name+" LV"+l.level),l.absorb(g)){if(b.money-=this.dragTowerData.baseCost,console.log("合成成功！扣除了 "+this.dragTowerData.baseCost+" 金币，剩余金币: "+b.money),this.draggingCard){var c=h("Canvas"),d=null==c?void 0:c.getComponent(S);d&&d.markCardAsPurchased(this.draggingCard)}return void this.clearDrag()}}else console.log("金币不足，无法合成。需要: "+this.dragTowerData.baseCost+", 当前: "+b.money);else console.log("无法合成："+(l?g?l.level>=l.MAX_LEVEL?"已达最大等级":"类型不匹配或只能用LV1合成":"拖拽塔组件缺失":"目标塔组件缺失"))}if(r.type!==P.EMPTY||r.isOccupied)console.log("格子不可用: type="+r.type+", isOccupied="+r.isOccupied);else if(b.money>=this.dragTowerData.baseCost)if(console.log("放置防御塔: "+this.dragTowerData.name+" 在位置 ("+n.getPosition().x.toFixed(1)+", "+n.getPosition().y.toFixed(1)+")"),this.placeTower(n.getPosition(),this.dragTowerData))if(r.isOccupied=!0,b.money-=this.dragTowerData.baseCost,console.log("放置成功！扣除了 "+this.dragTowerData.baseCost+" 金币，剩余金币: "+b.money),this.draggingCard){console.log("尝试标记商店卡片为已购买，draggingCard: "+this.draggingCard.name);var u=h("Canvas"),v=null==u?void 0:u.getComponent(S);v?(console.log("找到ShopSystem，调用markCardAsPurchased"),v.markCardAsPurchased(this.draggingCard)):console.error("未找到ShopSystem，无法标记卡片为已购买")}else console.warn("draggingCard为null，无法标记为已购买");else console.error("放置失败！防御塔创建失败");else console.log("金币不足，无法放置。需要: "+this.dragTowerData.baseCost+", 当前: "+b.money)}else console.log("未找到可放置的格子");this.clearDrag()}else{if(this.draggingPlacedTower){console.log("处理已放置防御塔的拖拽结束");var w=this.getTileAtPos(t);if(w){var T=w.node,f=w.script,C=this.getTowerOnTile(T.getPosition()),m=this.draggingPlacedTower.getComponent(x),y=null==C?void 0:C.getComponent(x);if(console.log("目标格子: type="+f.type+", isOccupied="+f.isOccupied),console.log("源防御塔: "+(m?"ID="+m.towerId+", level="+m.level+", exp="+m.currentExp+"/"+m.nextLevelNeeded:"null")),console.log("目标防御塔: "+(y?"ID="+y.towerId+", level="+y.level+", exp="+y.currentExp+"/"+y.nextLevelNeeded:"null")),C&&C!==this.draggingPlacedTower&&m&&y&&y.canAbsorb(m))console.log("可以合并！源: "+m.towerId+" LV"+m.level+", 目标: "+y.towerId+" LV"+y.level),y.absorb(m)?(this.clearOccupied(this.originalTowerPos),this.draggingPlacedTower.destroy(),console.log("合并成功！目标防御塔新等级: "+y.level+", 经验: "+y.currentExp+"/"+y.nextLevelNeeded)):(this.draggingPlacedTower.setPosition(this.originalTowerPos),this.restoreTowerSiblingIndex(this.draggingPlacedTower));else C||f.type!==P.EMPTY||f.isOccupied?(console.log("无法合并或移动，恢复原位置"),C&&console.log("原因: "+(C===this.draggingPlacedTower?"同一防御塔":m&&y?m.towerId!==y.towerId?"不同类型":1!==m.level?"只能拖LV1合成":y.level>=y.MAX_LEVEL?"目标已达最大等级":"未知原因":"防御塔组件缺失")),this.draggingPlacedTower.setPosition(this.originalTowerPos),this.restoreTowerSiblingIndex(this.draggingPlacedTower)):(console.log("移动到新位置"),f.isOccupied=!0,this.clearOccupied(this.originalTowerPos),this.restoreTowerSiblingIndex(this.draggingPlacedTower))}else console.log("未找到目标格子，恢复原位置"),this.draggingPlacedTower.setPosition(this.originalTowerPos),this.restoreTowerSiblingIndex(this.draggingPlacedTower);return this.draggingPlacedTower=null,this.originalTowerPos=null,void this.hideAllVisuals()}this.hideAllVisuals()}}},s.placeTower=function(e,i){if(!this.canvas||!this.towerPrefab)return console.error("placeTower失败: canvas或towerPrefab未设置"),!1;var t=w(this.towerPrefab);this.canvas.addChild(t),t.name="Tower_Instance";t.setPosition(p(e.x,e.y+20,e.z));var o=h("Canvas/GridMap");if(o&&o.parent){var n=o.getSiblingIndex();t.setSiblingIndex(Math.min(n+1,100))}else t.setSiblingIndex(50);var r=t.getComponent(x);return r?(r.init(i),console.log("防御塔已放置: "+i.name),!0):(console.error("placeTower失败: Tower组件未找到"),t.destroy(),!1)},s.clearDrag=function(){this.draggingTower&&(this.draggingTower.destroy(),this.draggingTower=null),this.draggingCard=null,this.dragTowerData=null,this.hideAllVisuals()},s.isInCancelArea=function(e){if(!this.cancelArea)return!1;var i=this.cancelArea.getComponent(d);if(!i)return!1;var t=this.cancelArea.getWorldPosition(),o=i.contentSize;return Math.abs(e.x-t.x)<o.width/2&&Math.abs(e.y-t.y)<o.height/2},s.getTileAtPos=function(e){if(this.gridMap||(this.gridMap=h("Canvas/GridMap")),!this.gridMap)return console.warn("GridMap未找到"),null;for(var i,t=null,o=100,n=r(this.gridMap.children);!(i=n()).done;){var s=i.value,a=s.getPosition(),l=f.distance(e,a);if(l<o){var g=s.getComponent(m);g&&(o=l,t={node:s,script:g,distance:l})}}return t?(console.log("找到最近格子，距离: "+t.distance.toFixed(1)+", type: "+t.script.type),{node:t.node,script:t.script}):(console.log("未找到格子，搜索位置: ("+e.x.toFixed(1)+", "+e.y.toFixed(1)+")"),null)},s.getTowerAtPos=function(e){if(this.canvas||(this.canvas=h("Canvas")),!this.canvas)return console.warn("getTowerAtPos: Canvas未找到"),null;var i=null,t=150,o=function o(n){if("DragPreview"!==n.name&&n.isValid){if(n.getComponent(x)){var r=n.getPosition(),s=f.distance(r,e);s<t&&(t=s,i=n)}n.children.forEach((function(e){return o(e)}))}};if(this.canvas.children.forEach((function(e){return o(e)})),i){var n=i.getPosition();console.log("找到防御塔: "+i.name+", 位置: ("+n.x.toFixed(1)+", "+n.y.toFixed(1)+"), 距离: "+t.toFixed(1))}else{console.log("未找到防御塔，搜索位置: ("+e.x.toFixed(1)+", "+e.y.toFixed(1)+")");var r=[],s=function e(i){i.getComponent(x)&&"DragPreview"!==i.name&&r.push(i),i.children.forEach((function(i){return e(i)}))};this.canvas.children.forEach((function(e){return s(e)})),r.length>0?(console.log("当前场景中有 "+r.length+" 个防御塔:"),r.forEach((function(i,t){var o=i.getPosition(),n=f.distance(o,e);console.log("  防御塔"+(t+1)+": "+i.name+", 位置: ("+o.x.toFixed(1)+", "+o.y.toFixed(1)+"), 距离搜索点: "+n.toFixed(1))}))):console.log("当前场景中没有防御塔")}return i},s.getTowerOnTile=function(e){if(this.canvas||(this.canvas=h("Canvas")),!this.canvas)return null;var i=null,t=30,o=function o(n){if("DragPreview"!==n.name&&n.isValid){if(n.getComponent(x)){var r=n.getPosition(),s=f.distance(r,e);s<t&&(t=s,i=n)}n.children.forEach((function(e){return o(e)}))}};return this.canvas.children.forEach((function(e){return o(e)})),i},s.restoreTowerSiblingIndex=function(e){if(e&&e.isValid){var i=h("Canvas/GridMap");if(i&&i.parent){var t=i.getSiblingIndex();e.setSiblingIndex(Math.min(t+1,100))}else e.setSiblingIndex(50)}},s.clearOccupied=function(e){this.gridMap||(this.gridMap=h("Canvas/GridMap")),this.gridMap&&this.gridMap.children.forEach((function(i){if(f.distance(i.getPosition(),e)<10){var t=i.getComponent(m);t&&(t.isOccupied=!1)}}))},i}(C)).prototype,"towerPrefab",[M],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),B=i(A.prototype,"cancelArea",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),H=A))||H));s._RF.pop()}}}));

System.register("chunks:///_virtual/Enemy.ts",["./rollupPluginModLoBabelHelpers.js","cc","./TouchManager.ts","./TileSlot.ts","./GameConfig.ts"],(function(e){var t,i,a,n,r,s,o,l,p,h,d,S,c,E,u,y,f,_,b,A,M;return{setters:[function(e){t=e.applyDecoratedDescriptor,i=e.inheritsLoose,a=e.initializerDefineProperty,n=e.assertThisInitialized,r=e.createForOfIteratorHelperLoose},function(e){s=e.cclegacy,o=e._decorator,l=e.Node,p=e.Label,h=e.Sprite,d=e.v3,S=e.resources,c=e.SpriteFrame,E=e.Texture2D,u=e.find,y=e.Vec3,f=e.Component},function(e){_=e.TouchManager},function(e){b=e.TileSlot,A=e.TileType},function(e){M=e.GameConfig}],execute:function(){var m,T,v,R,N,P,g,x,L,B;s._RF.push({},"8e81e2IdtJDrKVkWd7iLjpn","Enemy",void 0);var F=o.ccclass,H=o.property,D=e("EnemyType",function(e){return e[e.NORMAL=0]="NORMAL",e[e.FAST=1]="FAST",e[e.TANK=2]="TANK",e[e.ELITE=3]="ELITE",e[e.BOSS=4]="BOSS",e}({})),O=e("EnemyTextureConfig",((m={})[D.NORMAL]="enemy_normal",m[D.FAST]="enemy_fast",m[D.TANK]="enemy_tank",m[D.ELITE]="enemy_elite",m[D.BOSS]="enemy_boss",m)),Y="enemy";e("Enemy",(T=F("Enemy"),v=H(l),R=H(p),N=H(h),T((x=t((g=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),s=0;s<i;s++)r[s]=arguments[s];return t=e.call.apply(e,[this].concat(r))||this,a(t,"hpFillBar",x,n(t)),a(t,"hpLabel",L,n(t)),a(t,"bodySprite",B,n(t)),t.hp=5,t.maxHp=5,t.speed=100,t.enemyType=D.NORMAL,t.waypointPositions=[],t.currentWaypointIndex=0,t.gridMap=null,t.originalSpeed=100,t.killReward=2,t.baseScale=1,t.lastDirection=1,t}i(t,e);var s=t.prototype;return s.init=function(e,t){void 0===t&&(t=D.NORMAL),this.enemyType=t;var i=Math.max(0,e-1),a=Math.floor(i/5);switch(t){case D.FAST:this.maxHp=M.FAST_ENEMY_BASE_HP+i*M.FAST_ENEMY_HP_PER_WAVE,this.speed=M.FAST_ENEMY_SPEED,this.killReward=M.FAST_ENEMY_BASE_REWARD+a*M.FAST_ENEMY_REWARD_PER_5WAVE,this.setScale(.7);break;case D.TANK:this.maxHp=M.TANK_ENEMY_BASE_HP+i*M.TANK_ENEMY_HP_PER_WAVE,this.speed=M.TANK_ENEMY_SPEED,this.killReward=M.TANK_ENEMY_BASE_REWARD+a*M.TANK_ENEMY_REWARD_PER_5WAVE,this.setScale(1.3);break;case D.ELITE:this.maxHp=M.ELITE_ENEMY_BASE_HP+i*M.ELITE_ENEMY_HP_PER_WAVE,this.speed=M.ELITE_ENEMY_SPEED,this.killReward=M.ELITE_ENEMY_BASE_REWARD+a*M.ELITE_ENEMY_REWARD_PER_5WAVE,this.setScale(1.2);break;case D.BOSS:this.maxHp=M.BOSS_ENEMY_HP,this.speed=M.BOSS_ENEMY_SPEED,this.killReward=M.BOSS_ENEMY_REWARD,this.setScale(1.8);break;default:this.maxHp=M.NORMAL_ENEMY_BASE_HP+i*M.NORMAL_ENEMY_HP_PER_WAVE,this.speed=M.NORMAL_ENEMY_SPEED,this.killReward=M.NORMAL_ENEMY_BASE_REWARD+a*M.NORMAL_ENEMY_REWARD_PER_5WAVE,this.setScale(1)}this.originalSpeed=this.speed,this.maxHp=Math.max(1,Math.floor(this.maxHp)),this.hp=this.maxHp,this.updateHealthUI(),this.loadEnemyTexture(t)},s.setScale=function(e){this.baseScale=e},s.applySpriteScale=function(){this.bodySprite&&this.bodySprite.node&&this.bodySprite.node.setScale(d(this.baseScale,this.baseScale,1)),this.ensureHealthBarSize()},s.ensureHealthBarSize=function(){var e=1/this.baseScale;if(this.hpFillBar&&this.hpFillBar.parent){var t,i=this.hpFillBar.parent;this.isChildOf(i,null==(t=this.bodySprite)?void 0:t.node)&&i.setScale(d(e,e,1))}if(this.hpLabel&&this.hpLabel.node&&this.hpLabel.node.parent){var a,n,r=this.hpLabel.node.parent;if(this.isChildOf(r,null==(a=this.bodySprite)?void 0:a.node))r!==(null==(n=this.hpFillBar)?void 0:n.parent)&&r.setScale(d(e,e,1))}},s.isChildOf=function(e,t){if(!e||!t)return!1;for(var i=e;i;){if(i===t)return!0;i=i.parent}return!1},s.loadEnemyTexture=function(e){var t=this;if(this.bodySprite){this.bodySprite.node.active=!1;var i=O[e]||Y;S.load("Textures/"+i+"/spriteFrame",c,(function(e,a){e?S.load("Textures/"+i,E,(function(e,a){if(e)i!==Y?t.loadDefaultTexture():t.bodySprite&&(t.applySpriteScale(),t.bodySprite.node.active=!0);else if(t.bodySprite&&t.bodySprite.isValid){var n=new c;n.texture=a,t.bodySprite.spriteFrame=n,t.applySpriteScale(),t.bodySprite.node.active=!0}})):t.bodySprite&&t.bodySprite.isValid&&(t.bodySprite.spriteFrame=a,t.applySpriteScale(),t.bodySprite.node.active=!0)}))}},s.loadDefaultTexture=function(){var e=this;this.bodySprite&&S.load("Textures/enemy/spriteFrame",c,(function(t,i){t?S.load("Textures/enemy",E,(function(t,i){if(t)e.bodySprite&&(e.applySpriteScale(),e.bodySprite.node.active=!0);else if(e.bodySprite&&e.bodySprite.isValid){var a=new c;a.texture=i,e.bodySprite.spriteFrame=a,e.applySpriteScale(),e.bodySprite.node.active=!0}})):e.bodySprite&&e.bodySprite.isValid&&(e.bodySprite.spriteFrame=i,e.applySpriteScale(),e.bodySprite.node.active=!0)}))},s.updateHealthUI=function(){this.hpFillBar&&this.hpFillBar.setScale(d(Math.max(0,this.hp/this.maxHp),1,1)),this.hpLabel&&(this.hpLabel.string=Math.max(0,Math.floor(this.hp))+"/"+this.maxHp)},s.takeDamage=function(e){var t=Math.floor(e);this.hp=Math.max(0,this.hp-t),this.updateHealthUI(),this.hp<=0&&this.node&&this.node.isValid&&(_.money+=this.killReward,console.log("怪物被击杀，获得 "+this.killReward+" 金币，当前金币: "+_.money),this.node.destroy())},s.start=function(){this.gridMap=u("Canvas/GridMap"),this.generatePath()},s.generatePath=function(){if(this.gridMap||(this.gridMap=u("Canvas/GridMap")),this.gridMap){for(var e,t=null,i=null,a=[],n=r(this.gridMap.children);!(e=n()).done;){var s=e.value,o=s.getComponent(b);o&&(o.type===A.START?t=s:o.type===A.END?i=s:o.type===A.PATH&&a.push(s))}if(t&&i){this.waypointPositions=[t.getPosition()];for(var l=t.getPosition(),p=[].concat(a),h=i.getPosition();p.length>0;){p.sort((function(e,t){var i=e.getPosition(),a=t.getPosition(),n=y.distance(i,l),r=y.distance(a,l);return n+.3*y.distance(i,h)-(r+.3*y.distance(a,h))}));var d=p.shift();this.waypointPositions.push(d.getPosition()),l=d.getPosition()}this.waypointPositions.push(h)}}},s.update=function(e){if(!(0===this.waypointPositions.length||_.isGameOver||this.currentWaypointIndex>=this.waypointPositions.length)){var t=this.waypointPositions[this.currentWaypointIndex],i=this.node.getPosition(),a=d();y.subtract(a,t,i),a.length()<M.ENEMY_WAYPOINT_REACH_DISTANCE?(this.currentWaypointIndex++,this.currentWaypointIndex>=this.waypointPositions.length&&(_.baseHealth-=1,this.node.destroy())):(a.normalize(),this.node.setPosition(i.add(a.multiplyScalar(this.speed*e))),this.updateSpriteDirection(a.x)),this.updateZIndexByY()}},s.updateZIndexByY=function(){if(this.node&&this.node.parent){var e=this.node.position.y,t=Math.floor(199-179*(e+400)/800),i=Math.max(20,Math.min(199,t));this.node.setSiblingIndex(i)}},s.setSpawnOrder=function(e){},s.applySlow=function(e,t){var i=this;this.speed=Math.floor(this.originalSpeed*(1-e)),this.scheduleOnce((function(){i.node&&i.node.isValid&&(i.speed=i.originalSpeed)}),t)},s.updateSpriteDirection=function(e){if(this.bodySprite){var t=e<-.1?-1:e>.1?1:this.lastDirection;if(t!==this.lastDirection&&(this.lastDirection=t,this.bodySprite.node)){var i=this.bodySprite.node.getScale(),a=Math.abs(i.x);this.bodySprite.node.setScale(d(a*t,i.y,i.z)),this.ensureHealthBarAfterFlip(t)}}},s.ensureHealthBarAfterFlip=function(e){var t=1/this.baseScale,i=e;if(this.hpFillBar&&this.hpFillBar.parent){var a,n=this.hpFillBar.parent;this.isChildOf(n,null==(a=this.bodySprite)?void 0:a.node)&&n.setScale(d(t*i,t,1))}if(this.hpLabel&&this.hpLabel.node){var r,s,o=this.hpLabel.node;if(this.isChildOf(o,null==(r=this.bodySprite)?void 0:r.node))o.parent!==(null==(s=this.hpFillBar)?void 0:s.parent)&&o.setScale(d(t*i,t,1))}},t}(f)).prototype,"hpFillBar",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),L=t(g.prototype,"hpLabel",[R],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),B=t(g.prototype,"bodySprite",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),P=g))||P));s._RF.pop()}}}));

System.register("chunks:///_virtual/EnemySpawner.ts",["./rollupPluginModLoBabelHelpers.js","cc","./TileSlot.ts","./Enemy.ts","./TouchManager.ts","./GameConfig.ts","./WaveSystem.ts"],(function(e){var n,a,t,i,r,s,o,c,p,l,v,u,h,m,f,E,T,y;return{setters:[function(e){n=e.applyDecoratedDescriptor,a=e.inheritsLoose,t=e.initializerDefineProperty,i=e.assertThisInitialized},function(e){r=e.cclegacy,s=e._decorator,o=e.Prefab,c=e.Label,p=e.find,l=e.instantiate,v=e.Component},function(e){u=e.TileSlot,h=e.TileType},function(e){m=e.Enemy,f=e.EnemyType},function(e){E=e.TouchManager},function(e){T=e.GameConfig},function(e){y=e.WaveSystem}],execute:function(){var d,_,w,g,A,C,M;r._RF.push({},"025f6QPXHZIeb2Cxen2lpPg","EnemySpawner",void 0);var N=s.ccclass,S=s.property;e("EnemySpawner",(d=N("EnemySpawner"),_=S(o),w=S(c),d((C=n((A=function(e){function n(){for(var n,a=arguments.length,r=new Array(a),s=0;s<a;s++)r[s]=arguments[s];return n=e.call.apply(e,[this].concat(r))||this,t(n,"enemyPrefab",C,i(n)),t(n,"waveLabel",M,i(n)),n.currentWave=1,n.enemiesLeftToSpawn=T.INITIAL_WAVE_ENEMY_COUNT,n.spawnTimer=0,n.waveGapTimer=0,n.canvas=null,n.gridMap=null,n}a(n,e);var r=n.prototype;return r.start=function(){var e=p("Canvas");if(e&&(e.getComponent(y)||e.getComponentInChildren(y)))return console.log("检测到WaveSystem，禁用旧的EnemySpawner"),void(this.enabled=!1);this.canvas=p("Canvas"),this.gridMap=p("Canvas/GridMap")},r.update=function(e){var n;if(this.enabled&&!E.isGameOver){this.canvas||(this.canvas=p("Canvas"));var a=(null==(n=this.canvas)?void 0:n.children.filter((function(e){return"Enemy"===e.name})))||[];this.enemiesLeftToSpawn>0?(this.spawnTimer+=e,this.spawnTimer>=T.ENEMY_SPAWN_INTERVAL&&(this.spawnEnemyByWave(),this.enemiesLeftToSpawn--,this.spawnTimer=0)):0===a.length&&(this.waveGapTimer+=e,this.waveGapTimer>=T.WAVE_GAP_TIME&&(this.currentWave++,this.enemiesLeftToSpawn=T.INITIAL_WAVE_ENEMY_COUNT+(this.currentWave-1)*T.ENEMY_COUNT_PER_WAVE,this.waveGapTimer=0,this.waveLabel&&(this.waveLabel.string="WAVE: "+this.currentWave)))}},r.spawnEnemyByWave=function(){if(this.gridMap||(this.gridMap=p("Canvas/GridMap")),this.gridMap){var e=this.gridMap.children.find((function(e){var n=e.getComponent(u);return n&&n.type===h.START}));if(e){var n=l(this.enemyPrefab);if(this.canvas||(this.canvas=p("Canvas")),this.canvas){this.canvas.addChild(n),n.name="Enemy",n.setPosition(e.getPosition());var a=n.getComponent(m);if(a){var t=f.NORMAL;if(this.currentWave>T.ENEMY_TYPE_RANDOM_START_WAVE){var i=Math.random();i<T.FAST_ENEMY_SPAWN_CHANCE?t=f.FAST:i<T.TANK_ENEMY_SPAWN_CHANCE&&(t=f.TANK)}a.init(this.currentWave,t)}}else n.destroy()}}},n}(v)).prototype,"enemyPrefab",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),M=n(A.prototype,"waveLabel",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),g=A))||g));r._RF.pop()}}}));

System.register("chunks:///_virtual/GameConfig.ts",["cc"],(function(E){var _;return{setters:[function(E){_=E.cclegacy}],execute:function(){_._RF.push({},"39a78CsyStI5IpgAl97Vc1R","GameConfig",void 0);var A=E("GameConfig",(function(){}));A.INITIAL_MONEY=120,A.INITIAL_HEALTH=25,A.PREPARE_TIME=15,A.TOWER_COST=50,A.TOWER_ATTACK_RANGE=150,A.TOWER_BASE_ATTACK_INTERVAL=1.2,A.TOWER_MIN_ATTACK_INTERVAL=.3,A.TOWER_ATTACK_INTERVAL_REDUCTION_PER_LEVEL=.1,A.TOWER_BASE_DAMAGE=1,A.TOWER_BASE_SCALE=.65,A.TOWER_SCALE_PER_LEVEL=.05,A.TOWER_DAMAGE_GROWTH_PER_LEVEL=.6,A.TOWER_MERGE_COST=[2,3,3],A.NORMAL_ENEMY_BASE_HP=15,A.NORMAL_ENEMY_HP_PER_WAVE=8,A.NORMAL_ENEMY_SPEED=50,A.NORMAL_ENEMY_BASE_REWARD=2,A.NORMAL_ENEMY_REWARD_PER_5WAVE=1,A.FAST_ENEMY_BASE_HP=10,A.FAST_ENEMY_HP_PER_WAVE=5,A.FAST_ENEMY_SPEED=100,A.FAST_ENEMY_BASE_REWARD=2,A.FAST_ENEMY_REWARD_PER_5WAVE=1,A.TANK_ENEMY_BASE_HP=40,A.TANK_ENEMY_HP_PER_WAVE=15,A.TANK_ENEMY_SPEED=30,A.TANK_ENEMY_BASE_REWARD=3,A.TANK_ENEMY_REWARD_PER_5WAVE=1,A.ELITE_ENEMY_BASE_HP=150,A.ELITE_ENEMY_HP_PER_WAVE=30,A.ELITE_ENEMY_SPEED=45,A.ELITE_ENEMY_BASE_REWARD=10,A.ELITE_ENEMY_REWARD_PER_5WAVE=5,A.BOSS_ENEMY_HP=1500,A.BOSS_ENEMY_SPEED=25,A.BOSS_ENEMY_REWARD=0,A.ENEMY_KILL_REWARD=2,A.ENEMY_BASE_HP=15,A.ENEMY_HP_PER_WAVE=8,A.ENEMY_BASE_SPEED=50,A.ENEMY_SPEED_PER_WAVE=0,A.MIN_WAVE_ENEMY_COUNT=30,A.MAX_WAVE_ENEMY_COUNT=45,A.ENEMY_SPAWN_INTERVAL=.65,A.WAVE_GAP_TIME=5,A.ENEMY_TYPE_RANDOM_START_WAVE=3,A.FAST_ENEMY_SPAWN_CHANCE=.35,A.TANK_ENEMY_SPAWN_CHANCE=.25,A.BULLET_SPEED=800,A.BULLET_HIT_DISTANCE=10,A.ENEMY_WAYPOINT_REACH_DISTANCE=5,A.TILE_DETECTION_RADIUS=50,A.TOWER_DETECTION_RADIUS=20,A.OCCUPIED_CLEAR_DISTANCE=10,A.TILE_SIZE=80,_._RF.pop()}}}));

System.register("chunks:///_virtual/GridGenerator.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(e){var r,t,i,n,a,o,l,c,u,s;return{setters:[function(e){r=e.applyDecoratedDescriptor,t=e.inheritsLoose,i=e.initializerDefineProperty,n=e.assertThisInitialized},function(e){a=e.cclegacy,o=e._decorator,l=e.Prefab,c=e.instantiate,u=e.v3,s=e.Component}],execute:function(){var d,p,f,h,g,b,v;a._RF.push({},"c1d8cvYX7tDU7XjqSLQtzDr","GridGenerator",void 0);var y=o.ccclass,z=o.property,G=o.executeInEditMode;e("GridGenerator",(d=y("GridGenerator"),p=z(l),d(f=G((g=r((h=function(e){function r(){for(var r,t=arguments.length,a=new Array(t),o=0;o<t;o++)a[o]=arguments[o];return r=e.call.apply(e,[this].concat(a))||this,i(r,"tilePrefab",g,n(r)),i(r,"gridSize",b,n(r)),i(r,"generate",v,n(r)),r}t(r,e);var a=r.prototype;return a.update=function(){this.generate&&(this.generate=!1,this.createGrid())},a.createGrid=function(){this.node.removeAllChildren();for(var e=0;e<18;e++)for(var r=0;r<10;r++){var t=c(this.tilePrefab);this.node.addChild(t);var i=(r-4.5)*this.gridSize,n=(e-8.5)*this.gridSize;t.setPosition(u(i,n,0)),t.name="Tile_"+e+"_"+r}console.log("网格生成完成，请开始设计地图布局")},r}(s)).prototype,"tilePrefab",[p],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),b=r(h.prototype,"gridSize",[z],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 75}}),v=r(h.prototype,"generate",[z],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),f=h))||f)||f));a._RF.pop()}}}));

System.register("chunks:///_virtual/LevelData.ts",["cc","./TileSlot.ts"],(function(e){var t,n;return{setters:[function(e){t=e.cclegacy},function(e){n=e.TileType}],execute:function(){t._RF.push({},"44967xCUl5Ho5hQQAPQ+6zZ","LevelData",void 0),e("LevelConfig",function(){function e(){}return e.numberToTileType=function(e){switch(e){case 0:return n.VOID;case 1:return n.PATH;case 2:return n.EMPTY;case 3:return n.START;case 4:return n.END;default:return n.EMPTY}},e}()).DEFAULT_LEVEL={id:1,name:"默认关卡",layout:[[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0]]},t._RF.pop()}}}));

System.register("chunks:///_virtual/LevelLoader.ts",["./rollupPluginModLoBabelHelpers.js","cc","./TileSlot.ts","./LevelData.ts"],(function(e){var r,t,n,i,o,a,l,u,s,c,f,p,v,d,h,L;return{setters:[function(e){r=e.applyDecoratedDescriptor,t=e.inheritsLoose,n=e.initializerDefineProperty,i=e.assertThisInitialized,o=e.asyncToGenerator,a=e.regeneratorRuntime},function(e){l=e.cclegacy,u=e._decorator,s=e.Prefab,c=e.Component,f=e.instantiate,p=e.v3,v=e.resources,d=e.JsonAsset},function(e){h=e.TileSlot},function(e){L=e.LevelConfig}],execute:function(){var g,b,y,m,P,D,T;l._RF.push({},"d83det8RYpFar6FhUoVCPtV","LevelLoader",void 0);var w=u.ccclass,C=u.property;e("LevelLoader",(g=w("LevelLoader"),b=C(s),g((P=r((m=function(e){function r(){for(var r,t=arguments.length,o=new Array(t),a=0;a<t;a++)o[a]=arguments[a];return r=e.call.apply(e,[this].concat(o))||this,n(r,"tilePrefab",P,i(r)),n(r,"gridSize",D,i(r)),n(r,"levelConfigPath",T,i(r)),r.currentLevelData=null,r}t(r,e);var l=r.prototype;return l.loadLevelFromJson=function(){var e=o(a().mark((function e(r){return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,t){v.load(r,d,(function(t,n){if(t)return console.warn("无法加载关卡配置 "+r+"，使用默认关卡",t),void e(L.DEFAULT_LEVEL);try{var i=n.json;e(i)}catch(t){console.error("解析关卡配置失败: "+r,t),e(L.DEFAULT_LEVEL)}}))})));case 1:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}(),l.generateLevel=function(){var e=o(a().mark((function e(r){var t,n,i,o,l,u,s,c,v,d,g,b,y,m;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r){e.next=4;break}return e.next=3,this.loadLevelFromJson(this.levelConfigPath);case 3:r=e.sent;case 4:for(r||(console.error("无法加载关卡数据，使用默认关卡"),r=L.DEFAULT_LEVEL),this.currentLevelData=r,this.node.removeAllChildren(),n=r.layout,i=n.length,o=(null==(t=n[0])?void 0:t.length)||10,l=0;l<i;l++)for(u=0;u<o;u++)v=null!=(s=null==(c=n[l])?void 0:c[u])?s:2,d=L.numberToTileType(v),g=f(this.tilePrefab),this.node.addChild(g),b=(u-(o-1)/2)*this.gridSize,y=((i-1)/2-l)*this.gridSize,g.setPosition(p(b,y,0)),(m=g.getComponent(h))&&(m.type=d,m.updateVisual()),g.name="Tile_"+l+"_"+u;return console.log('关卡 "'+r.name+'" 生成完成'),e.abrupt("return",r);case 13:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}(),l.getCurrentLevelData=function(){return this.currentLevelData},r}(c)).prototype,"tilePrefab",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),D=r(m.prototype,"gridSize",[C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 75}}),T=r(m.prototype,"levelConfigPath",[C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"levels/level1"}}),y=m))||y));l._RF.pop()}}}));

System.register("chunks:///_virtual/LevelManager.ts",["./rollupPluginModLoBabelHelpers.js","cc","./LevelLoader.ts","./TouchManager.ts","./GameConfig.ts"],(function(e){var t,r,n,a,o,i,l,s,d,c,u,v,L,h;return{setters:[function(e){t=e.applyDecoratedDescriptor,r=e.inheritsLoose,n=e.initializerDefineProperty,a=e.assertThisInitialized,o=e.asyncToGenerator,i=e.regeneratorRuntime},function(e){l=e.cclegacy,s=e._decorator,d=e.Node,c=e.find,u=e.Component},function(e){v=e.LevelLoader},function(e){L=e.TouchManager},function(e){h=e.GameConfig}],execute:function(){var p,f,g,M,m;l._RF.push({},"f21a7koq7dCip4CoDP0HHmi","LevelManager",void 0);var y=s.ccclass,I=s.property;e("LevelManager",(p=y("LevelManager"),f=I(d),p((m=t((M=function(e){function t(){for(var t,r=arguments.length,o=new Array(r),i=0;i<r;i++)o[i]=arguments[i];return t=e.call.apply(e,[this].concat(o))||this,n(t,"gridMapNode",m,a(t)),t.currentLevelId=1,t.levelLoader=null,t}r(t,e);var l=t.prototype;return l.start=function(){if(this.gridMapNode)this.levelLoader=this.gridMapNode.getComponent(v),this.levelLoader||(this.levelLoader=this.gridMapNode.addComponent(v));else{var e=c("Canvas/GridMap");e&&(this.gridMapNode=e,this.levelLoader=e.getComponent(v),this.levelLoader||(this.levelLoader=e.addComponent(v)))}this.loadLevel(this.currentLevelId)},l.loadLevel=function(){var e=o(i().mark((function e(t){var r,n;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.levelLoader){e.next=3;break}return console.error("LevelLoader未找到"),e.abrupt("return");case 3:return this.currentLevelId=t,r="levels/level"+t,this.levelLoader.levelConfigPath=r,e.next=8,this.levelLoader.generateLevel();case 8:(n=e.sent)&&(void 0!==n.initialMoney?L.money=n.initialMoney:L.money=h.INITIAL_MONEY,void 0!==n.initialHealth?L.baseHealth=n.initialHealth:L.baseHealth=h.INITIAL_HEALTH,L.isGameOver=!1,console.log("关卡 "+t+" 加载完成: "+n.name));case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),l.reloadCurrentLevel=function(){this.loadLevel(this.currentLevelId)},l.loadNextLevel=function(){this.loadLevel(this.currentLevelId+1)},l.getCurrentLevelId=function(){return this.currentLevelId},t}(u)).prototype,"gridMapNode",[f],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),g=M))||g));l._RF.pop()}}}));

System.register("chunks:///_virtual/main",["./Bullet.ts","./DragDropSystem.ts","./Enemy.ts","./EnemySpawner.ts","./GameConfig.ts","./GridGenerator.ts","./LevelData.ts","./LevelLoader.ts","./LevelManager.ts","./ShopCard.ts","./ShopSystem.ts","./TileSlot.ts","./TouchManager.ts","./Tower.ts","./TowerType.ts","./UIBuilder.ts","./UIController.ts","./WaveSystem.ts"],(function(){return{setters:[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],execute:function(){}}}));

System.register("chunks:///_virtual/ShopCard.ts",["./rollupPluginModLoBabelHelpers.js","cc","./TowerType.ts","./TouchManager.ts"],(function(e){var t,a,o,i,r,n,s,l,h,c,u,d,f,p,m,b,C,w,g;return{setters:[function(e){t=e.applyDecoratedDescriptor,a=e.inheritsLoose,o=e.initializerDefineProperty,i=e.assertThisInitialized},function(e){r=e.cclegacy,n=e._decorator,s=e.Label,l=e.Button,h=e.Color,c=e.Graphics,u=e.UITransform,d=e.Sprite,f=e.resources,p=e.SpriteFrame,m=e.Texture2D,b=e.find,C=e.Component},function(e){w=e.TowerConfig},function(e){g=e.TouchManager}],execute:function(){var y,L,v,D,P,T,B,k,S,M,N;r._RF.push({},"fb21f9Nu4JPBLAtrtGvAheC","ShopCard",void 0);var x=n.ccclass,A=n.property,F="tower";e("ShopCard",(y=x("ShopCard"),L=A(s),v=A(s),D=A(s),P=A(l),y((k=t((B=function(e){function t(){for(var t,a=arguments.length,r=new Array(a),n=0;n<a;n++)r[n]=arguments[n];return t=e.call.apply(e,[this].concat(r))||this,o(t,"nameLabel",k,i(t)),o(t,"costLabel",S,i(t)),o(t,"descLabel",M,i(t)),o(t,"buyButton",N,i(t)),t.towerData=null,t.isPurchased=!1,t.lastMoneyCheck=-1,t}a(t,e);var r=t.prototype;return r.start=function(){this.findChildComponents()},r.update=function(){if(this.towerData&&this.costLabel&&!this.isPurchased){var e=g.money;e!==this.lastMoneyCheck&&(this.lastMoneyCheck=e,this.updatePriceColor())}},r.updatePriceColor=function(){this.towerData&&this.costLabel&&(g.money<this.towerData.baseCost?this.costLabel.color=new h(255,80,80,255):this.costLabel.color=new h(255,200,100,255))},r.findChildComponents=function(){if(!this.nameLabel){var e=this.node.getChildByName("NameLabel");e&&(this.nameLabel=e.getComponent(s))}if(!this.costLabel){var t=this.node.getChildByName("PriceArea");if(t){var a=t.getChildByName("CostLabel");a&&(this.costLabel=a.getComponent(s))}}if(!this.descLabel){var o=this.node.getChildByName("DescLabel");o&&(this.descLabel=o.getComponent(s))}},r.setTowerData=function(e){this.towerData=e,this.findChildComponents(),this.updateUI()},r.updateUI=function(){if(this.towerData){var e=w.getRarityColor(this.towerData.rarity),t=this.node.getChildByName("CardBorder");if(t){var a=t.getComponent(c);if(a){a.clear(),a.strokeColor=e,a.lineWidth=2.5;var o=this.node.getComponent(u);if(o){var i=o.width,r=o.height;a.roundRect(-i/2,-r/2,i,r,6),a.stroke()}}}this.nameLabel&&(this.nameLabel.string=this.towerData.name,this.nameLabel.color=e),this.costLabel&&(this.costLabel.string=""+this.towerData.baseCost),this.descLabel&&(this.descLabel.string=this.towerData.description,this.descLabel.color=new h(Math.floor(.7*e.r+70),Math.floor(.7*e.g+70),Math.floor(.7*e.b+70),255)),this.loadTowerIcon()}else console.warn("ShopCard: towerData is null")},r.loadTowerIcon=function(){var e=this;if(this.towerData){var t=this.node.getChildByName("TowerIcon");if(t){var a=t.getComponent(d);if(a){var o=this.towerData.spriteTexture||F;f.load("Textures/"+o+"/spriteFrame",p,(function(t,i){t?f.load("Textures/"+o,m,(function(t,i){if(t)o!==F&&e.loadDefaultIcon(a);else if(a&&a.isValid){var r=new p;r.texture=i,a.spriteFrame=r}})):a&&a.isValid&&(a.spriteFrame=i)}))}}}},r.loadDefaultIcon=function(e){f.load("Textures/tower/spriteFrame",p,(function(t,a){t?f.load("Textures/tower",m,(function(t,a){if(!t&&e&&e.isValid){var o=new p;o.texture=a,e.spriteFrame=o}})):e&&e.isValid&&(e.spriteFrame=a)}))},r.markAsPurchased=function(){console.log("ShopCard.markAsPurchased() 被调用，节点: "+this.node.name),this.isPurchased=!0;var e=this.node.getChildByName("PurchasedMask");e&&(e.active=!0),console.log("ShopCard 已标记为已购买，isPurchased: "+this.isPurchased)},r.resetPurchaseState=function(){this.isPurchased=!1;var e=this.node.getChildByName("PurchasedMask");e&&(e.active=!1)},r.onBuyClick=function(){if(this.towerData&&g.money>=this.towerData.baseCost){g.money-=this.towerData.baseCost,g.pendingTowerData=this.towerData,console.log("购买了 "+this.towerData.name+"，请拖拽到地图放置");var e=b("Canvas"),t=null==e?void 0:e.getComponent("ShopSystem");t&&"function"==typeof t.markCardAsPurchased?t.markCardAsPurchased(this.node):this.markAsPurchased()}},t}(C)).prototype,"nameLabel",[L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S=t(B.prototype,"costLabel",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),M=t(B.prototype,"descLabel",[D],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),N=t(B.prototype,"buyButton",[P],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),T=B))||T));r._RF.pop()}}}));

System.register("chunks:///_virtual/ShopSystem.ts",["./rollupPluginModLoBabelHelpers.js","cc","./TowerType.ts","./TouchManager.ts","./WaveSystem.ts","./ShopCard.ts","./DragDropSystem.ts"],(function(e){var t,o,n,r,i,a,s,l,h,d,c,C,u,f,p,g,v,m,S,y,P,w,T,b,B;return{setters:[function(e){t=e.applyDecoratedDescriptor,o=e.inheritsLoose,n=e.initializerDefineProperty,r=e.assertThisInitialized,i=e.createForOfIteratorHelperLoose},function(e){a=e.cclegacy,s=e._decorator,l=e.Node,h=e.Prefab,d=e.Button,c=e.Label,C=e.find,u=e.UITransform,f=e.Graphics,p=e.Color,g=e.v3,v=e.Sprite,m=e.Widget,S=e.Component},function(e){y=e.TowerRarity,P=e.TowerConfig},function(e){w=e.TouchManager},function(e){T=e.WaveSystem},function(e){b=e.ShopCard},function(e){B=e.DragDropSystem}],execute:function(){var R,E,L,N,z,W,k,x,D,O,I,A,H,_,F;a._RF.push({},"4cca91livJKKr2sc3k4DvoY","ShopSystem",void 0);var U=s.ccclass,M=s.property;e("ShopSystem",(R=U("ShopSystem"),E=M(l),L=M(l),N=M(h),z=M(d),W=M(d),k=M(c),R((O=t((D=function(e){function t(){for(var t,o=arguments.length,i=new Array(o),a=0;a<o;a++)i[a]=arguments[a];return t=e.call.apply(e,[this].concat(i))||this,n(t,"shopPanel",O,r(t)),n(t,"cardContainer",I,r(t)),n(t,"cardPrefab",A,r(t)),n(t,"refreshButton",H,r(t)),n(t,"toggleButton",_,r(t)),n(t,"refreshCostLabel",F,r(t)),t.FREE_REFRESH_COUNT=2,t.CARD_COUNT=4,t.freeRefreshLeft=2,t.currentCards=[],t.lastWave=0,t.waveSystem=null,t.isExpanded=!0,t.expandedHeight=195,t.collapsedHeight=10,t.dragDropSystem=null,t}o(t,e);var a=t.prototype;return a.start=function(){var e=this;console.log("=== ShopSystem.start() 开始 ===");var t=C("Canvas");if(t){var o=t.children.filter((function(e){return"ShopPanel"===e.name}));if(console.log("⚠️ 发现 "+o.length+" 个 ShopPanel 节点！"),o.length>1&&console.error("❌ 有多个 ShopPanel！这可能导致显示问题。"),this.waveSystem=t.getComponentInChildren(T),this.dragDropSystem=t.getComponent(B)||t.getComponentInChildren(B),!this.dragDropSystem){this.dragDropSystem=t.addComponent(B);var n=t.getComponentInChildren(w);n&&n.towerPrefab&&(this.dragDropSystem.towerPrefab=n.towerPrefab)}}this.cardPrefab=null,console.log("已清空 cardPrefab，将使用 createCardNode() 创建新卡片"),console.log("ShopSystem: 跳过模板查找，强制使用 createCardNode()"),this.refreshButton&&this.refreshButton.node.on(d.EventType.CLICK,this.onRefreshClick,this),this.toggleButton&&this.toggleButton.node.on(d.EventType.CLICK,this.onToggleClick,this),this.scheduleOnce((function(){if(e.cardContainer){if(e.shopPanel){var t=e.shopPanel.getComponent(u);console.log("🎪 ShopPanel 尺寸: "+(null==t?void 0:t.width)+"x"+(null==t?void 0:t.height)),console.log("🎪 ShopPanel 位置: ("+e.shopPanel.position.x+", "+e.shopPanel.position.y+")")}var o=e.cardContainer.getComponent(u);console.log("📦 CardContainer 尺寸: "+(null==o?void 0:o.width)+"x"+(null==o?void 0:o.height)),console.log("📦 CardContainer 位置: ("+e.cardContainer.position.x+", "+e.cardContainer.position.y+")"),console.log("📦 CardContainer 子节点数: "+e.cardContainer.children.length),e.refreshShop(),e.updateRefreshButton()}else console.log("ShopSystem: 等待 UIBuilder 初始化 CardContainer...")}),.2),this.scheduleOnce((function(){e.updateToggleButtonStyle()}),.5)},a.updateToggleButtonStyle=function(){if(this.toggleButton){var e=this.toggleButton.node.getComponent(f);if(e){e.clear(),e.fillColor=new p(22,26,38,255),e.roundRect(-40,-16,80,32,6),e.fill(),e.strokeColor=new p(200,170,100,255),e.lineWidth=2,e.roundRect(-40,-16,80,32,6),e.stroke();var t=10;e.fillColor=new p(255,255,255,255),this.isExpanded?(e.moveTo(0,-5),e.lineTo(-10,5),e.lineTo(t,5),e.lineTo(0,-5),e.fill()):(e.moveTo(0,5),e.lineTo(-10,-5),e.lineTo(t,-5),e.lineTo(0,5),e.fill())}var o=this.toggleButton.node.getChildByName("Label");o&&(o.active=!1)}},a.update=function(){if(!w.isGameOver&&this.shopPanel&&this.shopPanel.parent){500!==this.shopPanel.getSiblingIndex()&&this.shopPanel.setSiblingIndex(500)}if(!this.waveSystem){var e=C("Canvas");if(e){if(this.waveSystem=e.getComponentInChildren(T),!this.waveSystem)for(var t,o=i(e.children);!(t=o()).done;){var n=t.value,r=n.getComponent(T);if(r){this.waveSystem=r,console.log("🔍 找到 WaveSystem (方法2):",n.name);break}}this.waveSystem||(this.waveSystem=e.getComponent(T),this.waveSystem&&console.log("🔍 找到 WaveSystem (方法3): Canvas本身")),this.waveSystem&&console.log("✅ WaveSystem 已获取成功")}}if(this.waveSystem){var a=this.waveSystem.getCurrentWave();a>this.lastWave&&a>1?(console.log("🔄 新波次开始: "+this.lastWave+" -> "+a+", 重置免费刷新次数"),this.lastWave=a,this.freeRefreshLeft=this.FREE_REFRESH_COUNT,console.log("🔄 免费刷新次数已重置为: "+this.freeRefreshLeft)):a>this.lastWave&&1===a&&(console.log("🔄 第1波开始，与备战阶段共用刷新次数"),this.lastWave=a),0===a&&this.lastWave>0&&(console.log("🔄 回到备战阶段，重置状态"),this.lastWave=0,this.freeRefreshLeft=this.FREE_REFRESH_COUNT)}this.updateRefreshButton()},a.resetShop=function(){var e=this;console.log("完全重置商店..."),this.freeRefreshLeft=this.FREE_REFRESH_COUNT,this.lastWave=0,this.clearCards(),this.refreshShop(),this.isExpanded||this.expandShop(),this.scheduleOnce((function(){e.currentCards.forEach((function(e){var t=e.node.getComponent(b);t&&t.loadTowerIcon()})),console.log("商店卡片贴图已加载")}),.05),console.log("商店已完全重置")},a.refreshShop=function(){if(console.log("刷新商店..."),this.cardContainer){this.clearCards();for(var e=[].concat(P.TOWERS),t=0;t<this.CARD_COUNT&&0!==e.length;t++){var o=this.selectRandomTower(e);o&&this.createCard(o)}console.log("商店刷新完成，生成了 "+this.currentCards.length+" 张卡片"),this.layoutCards(),this.updateRefreshButton()}else console.error("CardContainer未设置！")},a.layoutCards=function(){var e=this.currentCards.length;if(0!==e){var t=-(100*e+25*(e-1))/2+50;this.currentCards.forEach((function(e,o){var n=t+125*o;e.node.setPosition(g(n,0,0))}))}},a.selectRandomTower=function(e){if(0===e.length)return null;for(var t=e.map((function(e){switch(e.rarity){case y.WHITE:return 3;case y.GREEN:return 2;case y.BLUE:default:return 1}})),o=t.reduce((function(e,t){return e+t}),0),n=Math.random()*o,r=0;r<e.length;r++)if((n-=t[r])<=0)return e[r];return e[0]},a.createCard=function(e){var t=this;if(this.cardContainer){console.log("=== ShopSystem.createCard: 创建卡片 ===");var o=this.createCardNode();if(o){o.active=!0,this.cardContainer.addChild(o);var n=o.getComponent(b)||o.addComponent(b);n.setTowerData(e),o.towerData=e,o.on(l.EventType.TOUCH_START,(function(r){n.isPurchased||t.dragDropSystem&&e&&(console.log("触摸卡片开始拖拽: "+e.name),t.dragDropSystem.startDrag(o,e))}),this),o.shopCard=n,this.currentCards.push({towerData:e,node:o})}else console.error("createCardNode() 返回null")}},a.createCardNode=function(){var e=100,t=155,o=new l("ShopCard");o.addComponent(u).setContentSize(e,t);var n=new l("CardBorder");o.addChild(n),n.addComponent(u).setContentSize(e,t);var r=n.addComponent(f);r.strokeColor=new p(150,150,150,255),r.lineWidth=2.5,r.roundRect(-50,-77.5,e,t,6),r.stroke();var i=new l("IconBackground");o.addChild(i),i.addComponent(u).setContentSize(94,123),i.setPosition(g(0,5,0));var a=i.addComponent(f);a.fillColor=new p(55,65,85,255),a.roundRect(-47,-61.5,94,123,4),a.fill();var s=new l("TowerIcon");o.addChild(s);var h=s.addComponent(u);h.setContentSize(85,85),h.anchorX=.5,h.anchorY=.5,s.setPosition(g(0,-5,0)),s.addComponent(v).sizeMode=v.SizeMode.CUSTOM;var d=new l("TopTextBackground");o.addChild(d);d.addComponent(u).setContentSize(94,36),d.setPosition(g(0,56.5,0));var C=d.addComponent(f);C.fillColor=new p(40,45,55,240),C.roundRect(-47,-18,94,36,3),C.fill();var m=this.createLabelNode("NameLabel","防御塔",14);o.addChild(m),m.setPosition(g(0,65.5,0));var S=m.getComponent(c);S.horizontalAlign=c.HorizontalAlign.CENTER,S.enableOutline=!0,S.outlineColor=new p(0,0,0,255),S.outlineWidth=2;var y=this.createLabelNode("DescLabel","描述",10);o.addChild(y),y.setPosition(g(0,49.5,0));var P=y.getComponent(c);P.horizontalAlign=c.HorizontalAlign.CENTER,P.enableOutline=!0,P.outlineColor=new p(0,0,0,200),P.outlineWidth=1.5,y.getComponent(u).setContentSize(92,14),P.overflow=c.Overflow.CLAMP;var w=new l("PriceBackground");o.addChild(w);w.addComponent(u).setContentSize(94,22),w.setPosition(g(0,-63.5,0));var T=w.addComponent(f);T.fillColor=new p(40,45,55,240),T.roundRect(-47,-11,94,22,3),T.fill();var b=new l("PriceArea");o.addChild(b),b.addComponent(u).setContentSize(60,22),b.setPosition(g(0,-65.5,0));var B=this.createLabelNode("CoinIcon","💰",13);b.addChild(B),B.setPosition(g(-16,0,0));var R=this.createLabelNode("CostLabel","30",16);b.addChild(R),R.setPosition(g(12,0,0));var E=R.getComponent(c);E.color=new p(255,220,100,255),E.enableOutline=!0,E.outlineColor=new p(80,60,0,255),E.outlineWidth=2;var L=new l("PurchasedMask");o.addChild(L),L.active=!1,L.addComponent(u).setContentSize(e,t);var N=L.addComponent(f);N.fillColor=new p(0,0,0,180),N.roundRect(-50,-77.5,e,t,6),N.fill();var z=this.createLabelNode("PurchasedLabel","已购买",14);L.addChild(z),z.setPosition(g(0,0,0));var W=z.getComponent(c);return W.color=new p(200,200,200),W.enableOutline=!0,W.outlineColor=new p(0,0,0,200),W.outlineWidth=1.5,o},a.createLabelNode=function(e,t,o){var n=new l(e);n.addComponent(u).setContentSize(130,25);var r=n.addComponent(c);return r.string=t,r.fontSize=o,r.color=p.WHITE,r.horizontalAlign=c.HorizontalAlign.CENTER,r.verticalAlign=c.VerticalAlign.CENTER,n},a.onRefreshClick=function(){w.isGameOver||this.freeRefreshLeft>0&&(this.freeRefreshLeft--,this.refreshShop())},a.onToggleClick=function(){w.isGameOver||(this.isExpanded?this.collapseShop():this.expandShop())},a.expandShop=function(){if(this.shopPanel){this.isExpanded=!0;var e=750,t=this.expandedHeight,o=this.shopPanel.getChildByName("PanelBackground");if(o){o.active=!0;var n=o.getComponent(u);n&&n.setContentSize(e,t);var r=o.getComponent(f);r&&(r.clear(),r.fillColor=new p(22,26,38,255),r.rect(-375,-t/2,e,t),r.fill(),r.strokeColor=new p(200,170,100,255),r.lineWidth=3,r.moveTo(-375,t/2),r.lineTo(375,t/2),r.stroke(),r.strokeColor=new p(100,90,60,150),r.lineWidth=1,r.moveTo(-375,t/2-4),r.lineTo(375,t/2-4),r.stroke(),r.strokeColor=new p(50,60,80,200),r.lineWidth=1,r.moveTo(-375,-t/2+1),r.lineTo(375,-t/2+1),r.stroke()),o.setPosition(g(0,0,0))}var i=this.shopPanel.getComponent(m),a=this.shopPanel.getComponent(u);i&&a&&(i.enabled=!1,a.setContentSize(e,t),this.shopPanel.setPosition(g(this.shopPanel.position.x,t/2,0)),i.bottom=0,i.enabled=!0),this.cardContainer&&(this.cardContainer.active=!0,this.currentCards.forEach((function(e){var t=e.node.getComponent(b);t&&t.loadTowerIcon()}))),this.refreshButton&&(this.refreshButton.node.active=!0);var s=this.shopPanel.getChildByName("TitleBar");s&&(s.active=!0);var l=this.shopPanel.getChildByName("LeftArea");l&&(l.active=!0),this.toggleButton&&(this.toggleButton.node.setPosition(g(this.toggleButton.node.position.x,t/2+18,0)),this.updateToggleButtonStyle())}},a.collapseShop=function(){if(this.shopPanel){this.isExpanded=!1;var e=14,t=750;this.cardContainer&&(this.cardContainer.active=!1),this.refreshButton&&(this.refreshButton.node.active=!1);var o=this.shopPanel.getChildByName("TitleBar");o&&(o.active=!1);var n=this.shopPanel.getChildByName("LeftArea");n&&(n.active=!1);var r=this.shopPanel.getChildByName("PanelBackground");if(r){r.active=!0;var i=r.getComponent(u);i&&i.setContentSize(t,e);var a=r.getComponent(f);a&&(a.clear(),a.fillColor=new p(22,26,38,255),a.rect(-375,-7,t,e),a.fill(),a.strokeColor=new p(200,170,100,255),a.lineWidth=3,a.moveTo(-375,7),a.lineTo(375,7),a.stroke()),r.setPosition(g(0,0,0))}var s=this.shopPanel.getComponent(m),l=this.shopPanel.getComponent(u);s&&l&&(s.enabled=!1,l.setContentSize(t,e),this.shopPanel.setPosition(g(this.shopPanel.position.x,7,0)),s.bottom=0,s.enabled=!0),this.toggleButton&&(this.toggleButton.node.setPosition(g(this.toggleButton.node.position.x,29,0)),this.updateToggleButtonStyle())}},a.updateRefreshButton=function(){if(this.refreshButton){var e="剩余 "+this.freeRefreshLeft+" 次",t=this.refreshButton.node.getChildByName("CostLabel");if(t){var o=t.getComponent(c);o&&(o.string=e)}var n=this.refreshButton.node.getChildByName("Label");if(n){var r=n.getComponent(c);r&&r.string.includes("剩余")&&(r.string=e)}this.refreshCostLabel&&(this.refreshCostLabel.string=e),this.refreshButton.interactable=this.freeRefreshLeft>0}},a.clearCards=function(){if(this.currentCards.forEach((function(e){e.node&&e.node.isValid&&e.node.destroy()})),this.currentCards=[],this.cardContainer){var e=this.cardContainer.children.slice();e.forEach((function(e){console.log("🧹 清除 CardContainer 中的旧节点: "+e.name),e.destroy()})),e.length>0&&console.log("✅ 已清除 "+e.length+" 个旧节点（包括模板）")}},a.markCardAsPurchased=function(e){console.log("标记卡片为已购买: "+e.name);var t=e.getComponent(b);if(t)t.markAsPurchased(),console.log("卡片已标记为已购买，显示遮罩");else{var o=e.getChildByName("PurchasedMask");o&&(o.active=!0,console.log("直接显示已购买遮罩"))}},a.updateCardLayout=function(){this.cardContainer&&this.currentCards.forEach((function(e,t){var o=e.node;if(o&&o.isValid){var n=o.getComponent(m);n&&(n.left=150*t+10)}}))},t}(S)).prototype,"shopPanel",[E],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),I=t(D.prototype,"cardContainer",[L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),A=t(D.prototype,"cardPrefab",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),H=t(D.prototype,"refreshButton",[z],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_=t(D.prototype,"toggleButton",[W],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),F=t(D.prototype,"refreshCostLabel",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),x=D))||x));a._RF.pop()}}}));

System.register("chunks:///_virtual/TileSlot.ts",["./rollupPluginModLoBabelHelpers.js","cc"],(function(e){var t,r,i,o,n,l,a,c,s,u,p,T,g;return{setters:[function(e){t=e.applyDecoratedDescriptor,r=e.inheritsLoose,i=e.initializerDefineProperty,o=e.assertThisInitialized},function(e){n=e.cclegacy,l=e._decorator,a=e.Enum,c=e.SpriteFrame,s=e.EDITOR,u=e.Sprite,p=e.Color,T=e.v3,g=e.Component}],execute:function(){var f,m,h,b,y,d,S,I,w,D,E,A;n._RF.push({},"b4b4d6RUK5LgL1fUSHgF46Z","TileSlot",void 0);var P=l.ccclass,v=l.property,k=l.executeInEditMode,R=e("TileType",function(e){return e[e.VOID=0]="VOID",e[e.PATH=1]="PATH",e[e.EMPTY=2]="EMPTY",e[e.START=3]="START",e[e.END=4]="END",e}({}));a(R);e("TileSlot",(f=P("TileSlot"),m=k(!0),h=v(c),b=v(c),y=v(c),d=v({type:R}),f(S=m((w=t((I=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),l=0;l<r;l++)n[l]=arguments[l];return t=e.call.apply(e,[this].concat(n))||this,i(t,"grassImg",w,o(t)),i(t,"dirtImg",D,o(t)),i(t,"rockImg",E,o(t)),i(t,"type",A,o(t)),t.isOccupied=!1,t}r(t,e);var n=t.prototype;return n.update=function(){s&&this.updateVisual()},n.start=function(){this.updateVisual()},n.updateVisual=function(){var e=this.getComponent(u);if(e){if(s)switch(e.spriteFrame=null,this.type){case R.EMPTY:e.color=new p(50,150,50);break;case R.PATH:e.color=new p(150,100,50);break;case R.START:e.color=new p(50,50,200);break;case R.END:e.color=new p(200,50,50);break;case R.VOID:e.color=new p(80,80,80)}else{var t,r=null;switch(this.type){case R.EMPTY:r=this.grassImg;break;case R.PATH:case R.START:case R.END:r=this.dirtImg;break;case R.VOID:r=this.rockImg}if(r)if(e.spriteFrame=r,e.color=new p(255,255,255,255),"Tile_0_0"===this.node.name)console.log("[TileSlot] Tile颜色已设置为: R="+e.color.r+", G="+e.color.g+", B="+e.color.b+", A="+e.color.a),console.log("[TileSlot] SpriteFrame: "+(null==(t=e.spriteFrame)?void 0:t.name))}this.type===R.PATH||this.type===R.START||this.type===R.END?this.node.setScale(T(.96,.96,1)):this.node.setScale(T(1,1,1))}},t}(g)).prototype,"grassImg",[h],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),D=t(I.prototype,"dirtImg",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),E=t(I.prototype,"rockImg",[y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),A=t(I.prototype,"type",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return R.EMPTY}}),S=I))||S)||S));n._RF.pop()}}}));

System.register("chunks:///_virtual/TouchManager.ts",["./rollupPluginModLoBabelHelpers.js","cc","./TileSlot.ts","./Tower.ts","./GameConfig.ts","./DragDropSystem.ts","./WaveSystem.ts"],(function(e){var i,t,n,o,r,a,s,l,c,g,h,u,d,p,T,v,f,m,y,C,w,P,I;return{setters:[function(e){i=e.applyDecoratedDescriptor,t=e.inheritsLoose,n=e.initializerDefineProperty,o=e.assertThisInitialized,r=e.createForOfIteratorHelperLoose},function(e){a=e.cclegacy,s=e._decorator,l=e.Prefab,c=e.Camera,g=e.Label,h=e.v3,u=e.find,d=e.Node,p=e.UITransform,T=e.Vec3,v=e.instantiate,f=e.Component},function(e){m=e.TileType,y=e.TileSlot},function(e){C=e.Tower},function(e){w=e.GameConfig},function(e){P=e.DragDropSystem},function(e){I=e.WaveSystem}],execute:function(){var M,E,S,b,D,O,_,L,A,U;a._RF.push({},"58e2fMnuN1I9ZsDxPPrcPbu","TouchManager",void 0);var N=s.ccclass,H=s.property;e("TouchManager",(M=N("TouchManager"),E=H(l),S=H(c),b=H(g),M(((U=function(e){function i(){for(var i,t=arguments.length,r=new Array(t),a=0;a<t;a++)r[a]=arguments[a];return i=e.call.apply(e,[this].concat(r))||this,n(i,"towerPrefab",_,o(i)),n(i,"mainCamera",L,o(i)),n(i,"moneyLabel",A,o(i)),i.draggingTower=null,i.originalTilePos=h(),i.canvas=null,i.gridMap=null,i.dragDropSystem=null,i.waveSystem=null,i}t(i,e);var a=i.prototype;return a.start=function(){var e,i,t;this.canvas=u("Canvas"),this.gridMap=u("Canvas/GridMap"),this.dragDropSystem=(null==(e=u("Canvas"))?void 0:e.getComponent(P))||(null==(i=u("Canvas"))?void 0:i.getComponentInChildren(P))||null,this.waveSystem=(null==(t=u("Canvas"))?void 0:t.getComponentInChildren(I))||null,this.dragDropSystem?console.log("TouchManager: 检测到DragDropSystem，已放置防御塔的拖拽由DragDropSystem处理"):(this.node.on(d.EventType.TOUCH_START,this.onTouchStart,this),this.node.on(d.EventType.TOUCH_MOVE,this.onTouchMove,this),this.node.on(d.EventType.TOUCH_END,this.onTouchEnd,this),this.node.on(d.EventType.TOUCH_CANCEL,this.onTouchEnd,this))},a.update=function(){this.moneyLabel&&(this.moneyLabel.string="金币: "+i.money)},a.getUIPos=function(e){var i=e.getUILocation(),t=this.node.getComponent(p);return t?t.convertToNodeSpaceAR(h(i.x,i.y,0)):h()},a.onTouchStart=function(e){if(!i.isGameOver&&!(this.dragDropSystem||this.waveSystem&&this.waveSystem.isInPreparePhase())){var t=this.getUIPos(e),n=this.getTileAtPos(t);if(n){var o=n.node,r=this.getTowerOnTile(o.getPosition());r&&(this.draggingTower=r,this.originalTilePos=o.getPosition().clone(),this.draggingTower.setSiblingIndex(99))}}},a.onTouchMove=function(e){this.draggingTower&&this.draggingTower.setPosition(this.getUIPos(e))},a.onTouchEnd=function(e){if(this.draggingTower){var i=this.getUIPos(e),t=this.getTileAtPos(i),n=!1;if(t){var o=t.node,r=t.script,a=this.getTowerOnTile(o.getPosition());if(a&&a!==this.draggingTower){var s=this.draggingTower.getComponent(C),l=a.getComponent(C);s&&l&&s.towerId===l.towerId&&s.level===l.level&&s.level<s.MAX_LEVEL&&(l.absorb(s),this.clearOccupied(this.originalTilePos),this.draggingTower.destroy(),n=!0)}else a||r.type!==m.EMPTY||r.isOccupied||(r.isOccupied=!0,this.clearOccupied(this.originalTilePos),n=!0)}n||this.draggingTower.setPosition(this.originalTilePos),this.draggingTower=null}},a.clearOccupied=function(e){this.gridMap||(this.gridMap=u("Canvas/GridMap")),this.gridMap&&this.gridMap.children.forEach((function(i){if(T.distance(i.getPosition(),e)<w.OCCUPIED_CLEAR_DISTANCE){var t=i.getComponent(y);t&&(t.isOccupied=!1)}}))},a.getTileAtPos=function(e){if(this.gridMap||(this.gridMap=u("Canvas/GridMap")),!this.gridMap)return null;for(var i,t=r(this.gridMap.children);!(i=t()).done;){var n=i.value;if(T.distance(n.getPosition(),e)<w.TILE_DETECTION_RADIUS){var o=n.getComponent(y);if(o)return{node:n,script:o}}}return null},a.getTowerOnTile=function(e){return this.canvas||(this.canvas=u("Canvas")),this.canvas&&this.canvas.children.find((function(i){return"Tower_Instance"===i.name&&i.isValid&&T.distance(i.getPosition(),e)<w.TOWER_DETECTION_RADIUS}))||null},a.spawnTower=function(e,i){if(this.canvas||(this.canvas=u("Canvas")),this.canvas){var t=v(this.towerPrefab);if(this.canvas.addChild(t),t.name="Tower_Instance",t.setPosition(e),i){var n=t.getComponent(C);n&&n.init(i)}}},i}(f)).money=w.INITIAL_MONEY,U.baseHealth=w.INITIAL_HEALTH,U.isGameOver=!1,U.pendingTowerData=null,_=i((O=U).prototype,"towerPrefab",[E],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),L=i(O.prototype,"mainCamera",[S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),A=i(O.prototype,"moneyLabel",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),D=O))||D));a._RF.pop()}}}));

System.register("chunks:///_virtual/Tower.ts",["./rollupPluginModLoBabelHelpers.js","cc","./Bullet.ts","./GameConfig.ts","./TowerType.ts","./Enemy.ts","./TouchManager.ts"],(function(e){var t,i,a,n,r,o,s,l,h,d,u,c,f,v,p,g,w,m,b,E,T,L,S,C,k,I,D,A;return{setters:[function(e){t=e.applyDecoratedDescriptor,i=e.inheritsLoose,a=e.initializerDefineProperty,n=e.assertThisInitialized,r=e.createClass},function(e){o=e.cclegacy,s=e._decorator,l=e.Prefab,h=e.Label,d=e.Sprite,u=e.find,c=e.v3,f=e.Node,v=e.Graphics,p=e.Color,g=e.UITransform,w=e.resources,m=e.SpriteFrame,b=e.Texture2D,E=e.instantiate,T=e.Vec3,L=e.Component},function(e){S=e.Bullet},function(e){C=e.GameConfig},function(e){k=e.TowerConfig,I=e.SkillType},function(e){D=e.Enemy},function(e){A=e.TouchManager}],execute:function(){var B,x,y,P,_,M,R,V,N;o._RF.push({},"b01cclZ9oNEy41ADiCpQpwJ","Tower",void 0);var O=s.ccclass,U=s.property;e("Tower",(B=O("Tower"),x=U(l),y=U(h),P=U(d),B((R=t((M=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),o=0;o<i;o++)r[o]=arguments[o];return t=e.call.apply(e,[this].concat(r))||this,a(t,"bulletPrefab",R,n(t)),a(t,"levelLabel",V,n(t)),a(t,"towerSprite",N,n(t)),t.towerData=null,t.towerId="",t.level=1,t.currentExp=0,t.MAX_LEVEL=4,t.isPreviewMode=!1,t.attackTimer=0,t.skillTimer=0,t.range=250,t.damage=5,t.attackInterval=1.2,t.canvas=null,t.damageBuff=0,t.speedBuff=0,t.buffTimer=0,t.labelBackground=null,t.DEFAULT_TEXTURE="tower",t}i(t,e);var o=t.prototype;return o.setPreviewMode=function(e){this.isPreviewMode=e},o.init=function(e){this.towerData=e,this.towerId=e.id,this.level=1,this.currentExp=0,this.range=e.baseRange,this.damage=Math.floor(e.baseDamage),this.attackInterval=e.baseAttackInterval,this.ensureSpriteAnchor(),this.updateUI(),this.updateAppearance()},o.start=function(){if(this.canvas=u("Canvas"),!this.towerData&&this.towerId){var e=k.getTowerData(this.towerId);e&&this.init(e)}this.ensureSpriteAnchor(),this.updateUI(),this.addSpriteOutline(),this.updateZIndexByPosition()},o.absorb=function(e){if(this.level>=this.MAX_LEVEL)return console.log("防御塔已达最大等级，无法继续合成"),!1;if(e.towerId!==this.towerId)return console.log("合成失败：类型不匹配。当前: "+this.towerId+", 目标: "+e.towerId),!1;if(1!==e.level)return console.log("合成失败：只能吸收 LV1 的塔。目标等级: LV"+e.level),!1;var t=this.currentExp,i=this.level,a=this.nextLevelNeeded;if(this.currentExp+=1,console.log("合成中："+this.towerId+" LV"+this.level+" ("+t+"/"+a+") -> ("+this.currentExp+"/"+a+")"),this.currentExp>=a){var n,r;this.level++,this.currentExp=0,console.log("升级成功："+this.towerId+" LV"+i+" -> LV"+this.level);var o=(null==(n=this.towerData)?void 0:n.baseDamage)||5;this.damage=Math.floor(o*(1+(this.level-1)*C.TOWER_DAMAGE_GROWTH_PER_LEVEL)),this.attackInterval=Math.max(.3,((null==(r=this.towerData)?void 0:r.baseAttackInterval)||1.2)-.1*(this.level-1))}else console.log("合成成功但未升级："+this.towerId+" LV"+this.level+" ("+this.currentExp+"/"+this.nextLevelNeeded+")");return this.updateUI(),this.updateAppearance(),!0},o.canAbsorb=function(e){return!(this.level>=this.MAX_LEVEL)&&(e.towerId===this.towerId&&1===e.level)},o.updateUI=function(){if(this.isPreviewMode){var e=this.node.getChildByName("LevelIndicator");e&&(e.active=!1),this.levelLabel&&(this.levelLabel.node.active=!1);var t=C.TOWER_BASE_SCALE;this.node.setScale(c(t,t,1))}else{if(this.levelLabel&&this.towerData){var i=k.getRarityColor(this.towerData.rarity);this.drawLevelIndicator(i),this.levelLabel.node.active=!1}var a=C.TOWER_BASE_SCALE+(this.level-1)*C.TOWER_SCALE_PER_LEVEL;this.node.setScale(c(a,a,1));var n=this.node.getChildByName("LevelIndicator");if(n){var r=1/a;n.setScale(c(r,r,1))}}},o.drawLevelIndicator=function(e){var t,i=this.node.getChildByName("LevelIndicator");i||(i=new f("LevelIndicator"),this.node.addChild(i),i.setSiblingIndex(999)),i.setPosition(c(0,70,0));var a=i.getComponent(v);a||(a=i.addComponent(v)),a.clear();for(var n=this.MAX_LEVEL,r=-(8*n*2+2*(n-1))/2+8,o=0;o<n;o++){var s=r+18*o;o<this.level?(a.fillColor=new p(255,200,50,255),this.drawStar(a,s,8,8,3.2),a.fill()):(a.strokeColor=new p(100,100,100,150),a.lineWidth=1,this.drawStar(a,s,8,6.4,2.4),a.stroke())}if(this.level<this.MAX_LEVEL)for(var l=this.nextLevelNeeded+1,d=this.currentExp+1,u=-(14*l+2*(l-1))/2,w=0;w<l;w++){var m=u+16*w;a.fillColor=w<d?new p(80,200,80,255):new p(50,45,40,255),a.rect(m,-10,14,8),a.fill(),a.strokeColor=new p(20,20,20,255),a.lineWidth=1,a.rect(m,-10,14,8),a.stroke()}else{a.fillColor=new p(255,200,50,255),a.rect(-25,-10,50,8),a.fill(),a.strokeColor=new p(20,20,20,255),a.lineWidth=1,a.rect(-25,-10,50,8),a.stroke()}var b=i.getChildByName("NameLabel");if(!b){b=new f("NameLabel"),i.addChild(b);var E=b.addComponent(h);E.fontSize=16,E.enableOutline=!0,E.outlineWidth=2,E.horizontalAlign=h.HorizontalAlign.CENTER,E.verticalAlign=h.VerticalAlign.CENTER,b.addComponent(g).setContentSize(100,22)}b.setPosition(c(0,-20,0));var T=b.getComponent(h);T.string=(null==(t=this.towerData)?void 0:t.name)||"",T.color=e,T.outlineColor=p.BLACK},o.drawStar=function(e,t,i,a,n){for(var r=Math.PI/5,o=Math.PI/2,s=0;s<10;s++){var l=s%2==0?a:n,h=o+s*r,d=t+l*Math.cos(h),u=i+l*Math.sin(h);0===s?e.moveTo(d,u):e.lineTo(d,u)}e.close()},o.updateAppearance=function(){var e="DragPreview"===this.node.name;if(!this.towerSprite&&this.towerData&&(this.towerSprite=this.node.getComponent(d),!this.towerSprite)){var t=this.node.children.find((function(e){return e.getComponent(d)}));t&&(this.towerSprite=t.getComponent(d))}if(this.towerSprite&&this.towerData&&(this.towerSprite.color=p.WHITE,this.towerData.spriteTexture&&this.loadTowerTexture(this.towerData.spriteTexture)),this.towerData&&!e){var i=k.getRarityName(this.towerData.rarity);this.node.name=this.towerData.name+"_"+i+"_LV"+this.level}},o.loadTowerTexture=function(e,t){var i=this;void 0===t&&(t=!1),this.towerSprite&&w.load("Textures/"+e+"/spriteFrame",m,(function(a,n){a?w.load("Textures/"+e,b,(function(a,n){if(a)return console.warn("加载贴图失败: "+e,a),void(t||e===i.DEFAULT_TEXTURE||(console.log("使用默认贴图: "+i.DEFAULT_TEXTURE),i.loadTowerTexture(i.DEFAULT_TEXTURE,!0)));if(i.towerSprite&&i.towerSprite.isValid){var r=new m;r.texture=n,i.towerSprite.spriteFrame=r,i.ensureSpriteAnchor()}})):i.towerSprite&&i.towerSprite.isValid&&(i.towerSprite.spriteFrame=n,i.ensureSpriteAnchor())}))},o.ensureSpriteAnchor=function(){var e=this.node.getComponent(g);if(e&&(e.anchorX=.5,e.anchorY=.5),this.towerSprite&&this.towerSprite.node!==this.node){var t=this.towerSprite.node.getComponent(g);t&&(t.anchorX=.5,t.anchorY=.5),this.towerSprite.node.setPosition(c(0,0,0))}},o.update=function(e){if("DragPreview"!==this.node.name&&!A.isGameOver){this.updateZIndexByPosition(),this.buffTimer>0&&(this.buffTimer-=e,this.buffTimer<=0&&(this.damageBuff=0,this.speedBuff=0)),this.attackTimer+=e,this.skillTimer+=e;var t=this.attackInterval*(1-this.speedBuff);if(this.attackTimer>=t&&(this.shoot(),this.attackTimer=0),this.towerData&&this.towerData.skillType!==I.NONE){var i=this.towerData.skillCooldown||0;i>0&&this.skillTimer>=i&&(this.useSkill(),this.skillTimer=0)}}},o.shoot=function(){var e=this.findNearestEnemy();if(e&&this.bulletPrefab&&(this.canvas||(this.canvas=u("Canvas")),this.canvas)){var t=E(this.bulletPrefab);this.canvas.addChild(t),t.setPosition(this.node.getPosition());var i=t.getComponent(S);if(i){var a=Math.floor(this.damage*(1+this.damageBuff));i.setTarget(e),i.damage=a,this.towerData&&(i.towerData=this.towerData,i.towerLevel=this.level)}}},o.useSkill=function(){if(this.towerData&&this.canvas){var e=this.towerData.skillType,t=this.towerData.skillValue;switch(e){case I.AOE_DAMAGE:this.useAOESkill(t);break;case I.BUFF_DAMAGE:this.useBuffDamageSkill(t);break;case I.BUFF_SPEED:this.useBuffSpeedSkill(t)}}},o.useAOESkill=function(e){var t=this;this.findEnemiesInRange(this.range).forEach((function(i){var a=i.getComponent(D);if(a){var n=Math.floor(t.damage*e);a.takeDamage(n)}}))},o.useBuffDamageSkill=function(e){var i=this;this.findTowersInRange(1.5*this.range).forEach((function(a){var n=a.getComponent(t);n&&n!==i&&(n.damageBuff=e,n.buffTimer=5)}))},o.useBuffSpeedSkill=function(e){var i=this;this.findTowersInRange(1.5*this.range).forEach((function(a){var n=a.getComponent(t);n&&n!==i&&(n.speedBuff=e,n.buffTimer=5)}))},o.findEnemiesInRange=function(e){if(!this.canvas)return[];var t=this.node.getPosition();return this.canvas.children.filter((function(i){return!("Enemy"!==i.name||!i.isValid)&&T.distance(t,i.getPosition())<=e}))},o.findTowersInRange=function(e){var t=this;if(!this.canvas)return[];var i=this.node.getPosition();return this.canvas.children.filter((function(a){return!(!a.name.includes("Tower_Instance")||!a.isValid||a===t.node)&&T.distance(i,a.getPosition())<=e}))},o.findNearestEnemy=function(){if(this.canvas||(this.canvas=u("Canvas")),!this.canvas)return null;var e=this.canvas.children.filter((function(e){return"Enemy"===e.name&&e.isValid}));if(0===e.length)return null;var t=null,i=this.range,a=this.node.getPosition();return e.forEach((function(e){var n=T.distance(a,e.getPosition());n<i&&(i=n,t=e)})),t},o.createLabelBackground=function(){var e;if(this.levelLabel&&!this.labelBackground){this.labelBackground=new f("LabelBackground"),null==(e=this.levelLabel.node.parent)||e.addChild(this.labelBackground);var t=this.levelLabel.node.getSiblingIndex();this.labelBackground.setSiblingIndex(t),this.levelLabel.node.setSiblingIndex(t+1),this.labelBackground.addComponent(v).fillColor=new p(0,0,0,180),this.updateLabelBackground()}},o.updateLabelBackground=function(){var e=this;this.labelBackground&&this.levelLabel&&this.scheduleOnce((function(){if(e.labelBackground&&e.levelLabel&&e.labelBackground.isValid){var t=e.labelBackground.getComponent(v);if(t){var i=e.levelLabel.node.getComponent(g);if(i){e.levelLabel.updateRenderData(!0),t.clear();var a=i.width+8,n=i.height+8,r=Math.max(a,60),o=Math.max(n,30);t.fillColor=new p(0,0,0,120),t.roundRect(-r/2,-o/2,r,o,3),t.fill(),e.labelBackground.setPosition(e.levelLabel.node.getPosition())}}}}),.05)},o.addSpriteOutline=function(){this.towerSprite},o.updateZIndexByPosition=function(){if(this.node&&this.node.isValid&&this.node.parent&&"DragPreview"!==this.node.name&&!(this.node.getSiblingIndex()>=9e3)){var e=this.node.position.y,t=Math.floor(399-199*(e+400)/800),i=Math.max(200,Math.min(399,t));this.node.getSiblingIndex()!==i&&this.node.setSiblingIndex(i)}},r(t,[{key:"nextLevelNeeded",get:function(){return this.level>=this.MAX_LEVEL?0:C.TOWER_MERGE_COST[this.level-1]||2}}]),t}(L)).prototype,"bulletPrefab",[x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),V=t(M.prototype,"levelLabel",[y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),N=t(M.prototype,"towerSprite",[P],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_=M))||_));o._RF.pop()}}}));

System.register("chunks:///_virtual/TowerType.ts",["cc","./GameConfig.ts"],(function(e){var t,r,a,n;return{setters:[function(e){t=e.cclegacy,r=e.Enum,a=e.Color},function(e){n=e.GameConfig}],execute:function(){t._RF.push({},"9f1c7BvNbFIoqw9Mqu+cJXu","TowerType",void 0);var i=e("TowerRarity",function(e){return e[e.WHITE=0]="WHITE",e[e.GREEN=1]="GREEN",e[e.BLUE=2]="BLUE",e}({}));r(i);var s=e("TowerCategory",function(e){return e[e.PHYSICAL=0]="PHYSICAL",e[e.MAGIC=1]="MAGIC",e[e.SUPPORT=2]="SUPPORT",e[e.AOE=3]="AOE",e}({}));r(s);var o=e("SkillType",function(e){return e[e.NONE=0]="NONE",e[e.AOE_DAMAGE=1]="AOE_DAMAGE",e[e.SLOW=2]="SLOW",e[e.BUFF_DAMAGE=3]="BUFF_DAMAGE",e[e.BUFF_SPEED=4]="BUFF_SPEED",e[e.CHAIN=5]="CHAIN",e[e.SPLASH=6]="SPLASH",e}({}));r(o);var l=n.TILE_SIZE,c=1.5*l,u=2.5*l,E=3.5*l;e("TowerConfig",function(){function e(){}return e.getTowerData=function(e){return this.TOWERS.find((function(t){return t.id===e}))||null},e.getRarityColor=function(e){switch(e){case i.WHITE:return new a(255,255,255,255);case i.GREEN:return new a(0,255,100,255);case i.BLUE:return new a(100,200,255,255);default:return a.WHITE}},e.getRarityName=function(e){switch(e){case i.WHITE:return"普通";case i.GREEN:return"精良";case i.BLUE:return"稀有";default:return"未知"}},e}()).TOWERS=[{id:"tower_archer",name:"射手",rarity:i.WHITE,category:s.PHYSICAL,baseCost:25,baseDamage:6,baseAttackInterval:.6,baseRange:E,skillType:o.NONE,skillValue:0,description:"远程物理",spriteTexture:"tower_gj"},{id:"tower_mage",name:"法师",rarity:i.WHITE,category:s.MAGIC,baseCost:30,baseDamage:8,baseAttackInterval:1,baseRange:u,skillType:o.NONE,skillValue:0,description:"远程魔法",spriteTexture:"tower_fs"},{id:"tower_guard",name:"战士",rarity:i.WHITE,category:s.PHYSICAL,baseCost:35,baseDamage:15,baseAttackInterval:1.5,baseRange:c,skillType:o.NONE,skillValue:0,description:"高伤害",spriteTexture:"tower_sw"},{id:"tower_cannon",name:"小炮",rarity:i.GREEN,category:s.AOE,baseCost:50,baseDamage:18,baseAttackInterval:2,baseRange:c,skillType:o.SPLASH,skillValue:.6,skillCooldown:0,description:"范围伤害",spriteTexture:"tower_hp"},{id:"tower_ice",name:"冰法",rarity:i.GREEN,category:s.SUPPORT,baseCost:60,baseDamage:4,baseAttackInterval:.5,baseRange:u,skillType:o.SLOW,skillValue:.4,skillCooldown:0,description:"减速",spriteTexture:"tower_hb"},{id:"tower_lightning",name:"闪电塔",rarity:i.BLUE,category:s.MAGIC,baseCost:120,baseDamage:12,baseAttackInterval:1,baseRange:E,skillType:o.CHAIN,skillValue:4,skillCooldown:2,description:"连锁攻击",spriteTexture:"tower_ld"}],t._RF.pop()}}}));

System.register("chunks:///_virtual/UIBuilder.ts",["./rollupPluginModLoBabelHelpers.js","cc","./ShopSystem.ts","./DragDropSystem.ts","./TouchManager.ts","./WaveSystem.ts","./GameConfig.ts","./UIController.ts"],(function(e){var n,t,o,i,a,r,l,d,s,C,c,h,v,u,p,g,m,f,w,b,I,A,B,S,L;return{setters:[function(e){n=e.applyDecoratedDescriptor,t=e.inheritsLoose,o=e.initializerDefineProperty,i=e.assertThisInitialized},function(e){a=e.cclegacy,r=e._decorator,l=e.Node,d=e.SpriteFrame,s=e.find,C=e.Label,c=e.UITransform,h=e.Widget,v=e.Graphics,u=e.Color,p=e.v3,g=e.Button,m=e.Sprite,f=e.director,w=e.Component},function(e){b=e.ShopSystem},function(e){I=e.DragDropSystem},function(e){A=e.TouchManager},function(e){B=e.WaveSystem},function(e){S=e.GameConfig},function(e){L=e.UIController}],execute:function(){var T,P,R,U,z,W,y,k,E,M,H;a._RF.push({},"b6ac5B0nRdOhInoMfv2lL7d","UIBuilder",void 0);var O=r.ccclass,x=r.property;e("UIBuilder",(T=O("UIBuilder"),P=x(l),R=x(d),U=x(d),z=x(d),T((k=n((y=function(e){function n(){for(var n,t=arguments.length,a=new Array(t),r=0;r<t;r++)a[r]=arguments[r];return n=e.call.apply(e,[this].concat(a))||this,o(n,"canvas",k,i(n)),o(n,"buttonSprite",E,i(n)),o(n,"cardBgSprite",M,i(n)),o(n,"panelBgSprite",H,i(n)),n}t(n,e);var a=n.prototype;return a.start=function(){console.log("=== UIBuilder.start() 被调用 ==="),this.canvas||(this.canvas=s("Canvas")),this.canvas?(console.log("UIBuilder: Canvas已找到，开始构建UI"),this.buildAllUI(),console.log("=== UIBuilder UI构建完成 ===")):console.error("UIBuilder: 未找到Canvas节点！请确保UIBuilder组件已添加到Canvas节点上")},a.buildAllUI=function(){console.log("UIBuilder: 开始构建所有UI"),s("Canvas/TopBar")?console.warn("UIBuilder: TopBar已存在，跳过创建。如果UI显示异常，请删除现有的TopBar节点"):(console.log("UIBuilder: 创建TopBar"),this.createTopBar(),console.log("UIBuilder: 创建ShopPanel"),this.createShopUI(),console.log("UIBuilder: 创建GameOverPanel"),this.createGameOverUI(),console.log("UIBuilder: 创建CancelArea"),this.createCancelArea(),console.log("UIBuilder: 连接UI组件"),this.connectUIComponents(),console.log("UIBuilder: 所有UI构建完成"))},a.connectUIComponents=function(){var e=this;this.scheduleOnce((function(){var n=s("Canvas/TopBar");if(n){var t=n.getChildByName("CenterArea"),o=null==t?void 0:t.getChildByName("CountdownLabel");if(o){var i=o.getComponent(C);if(i){var a=e.canvas.getComponent(B)||e.canvas.getComponentInChildren(B);a&&(a.countdownLabel=i,console.log("倒计时标签已连接到WaveSystem"))}}}else console.warn("TopBar未找到，无法连接组件")}),.2)},a.createTopBar=function(){console.log("UIBuilder: 开始创建TopBar");var e=70,n=750,t=new l("TopBar");this.canvas.addChild(t),t.setSiblingIndex(998),t.addComponent(c).setContentSize(n,e);var o=t.addComponent(h);o.isAlignTop=!0,o.top=0,o.isAlignLeft=!0,o.isAlignRight=!0,o.left=0,o.right=0,o.alignMode=h.AlignMode.ALWAYS;var i=new l("Background");t.addChild(i),i.setSiblingIndex(0),i.addComponent(c).setContentSize(n,e);var a=i.addComponent(v);a.fillColor=new u(0,0,0,200),a.rect(-375,-35,n,e),a.fill(),a.strokeColor=new u(255,215,0,100),a.lineWidth=1,a.moveTo(-375,-35),a.lineTo(375,-35),a.stroke();var r=new l("LeftArea");t.addChild(r),r.setPosition(p(-255,-5,0));var d=this.createCapsuleBg("MoneyBg",110,36,new u(0,0,0,150),new u(255,215,0,200));r.addChild(d),d.setPosition(p(-60,0,0));var s=this.createLabel("MoneyLabel","200",22,new u(255,235,100));d.addChild(s),s.setPosition(p(10,0,0));var g=s.getComponent(C);g.enableOutline=!0,g.outlineColor=new u(50,40,0,255),g.outlineWidth=1.5;var m=this.createLabel("Icon","💰",24,u.WHITE);d.addChild(m),m.setPosition(p(-35,2,0));var f=this.createCapsuleBg("HealthBg",100,36,new u(0,0,0,150),new u(255,80,80,200));r.addChild(f),f.setPosition(p(60,0,0));var w=this.createLabel("HealthLabel","10",22,new u(255,120,120));f.addChild(w),w.setPosition(p(10,0,0));var b=w.getComponent(C);b.enableOutline=!0,b.outlineColor=new u(60,10,10,255),b.outlineWidth=1.5;var I=this.createLabel("Icon","❤️",22,u.WHITE);f.addChild(I),I.setPosition(p(-30,2,0));var A=new l("CenterArea");t.addChild(A),A.setPosition(p(0,-15,0));var B=this.createLabel("CountdownLabel","⏳ 备战 15s",20,new u(200,255,200));A.addChild(B);var S=B.getComponent(C);S.enableOutline=!0,S.outlineColor=new u(0,50,0,200),S.outlineWidth=2;var L=new l("RightArea");t.addChild(L),L.setPosition(p(295,-5,0));var T=this.createCapsuleBg("WaveBg",120,36,new u(0,0,0,150),new u(100,200,255,200));L.addChild(T);var P=this.createLabel("Icon","⚔️",20,u.WHITE);T.addChild(P),P.setPosition(p(-40,2,0));var R=this.createLabel("WaveLabel","1/30",20,new u(200,240,255));T.addChild(R),R.setPosition(p(5,0,0));var U=R.getComponent(C);U.enableOutline=!0,U.outlineColor=new u(0,30,60,255),U.outlineWidth=1.5,console.log("UIBuilder: TopBar创建完成")},a.createCapsuleBg=function(e,n,t,o,i){var a=new l(e);a.addComponent(c).setContentSize(n,t);var r=a.addComponent(v);return r.fillColor=o,r.roundRect(-n/2,-t/2,n,t,t/2),r.fill(),r.strokeColor=i,r.lineWidth=2,r.roundRect(-n/2,-t/2,n,t,t/2),r.stroke(),a},a.createShopUI=function(){var e=220,n=750,t=new l("ShopPanel");this.canvas.addChild(t),t.setSiblingIndex(999),t.addComponent(c).setContentSize(n,e);var o=t.addComponent(h);o.isAlignBottom=!0,o.bottom=0,o.isAlignLeft=!0,o.isAlignRight=!0,o.left=0,o.right=0,o.alignMode=h.AlignMode.ALWAYS;var i=new l("PanelBackground");t.addChild(i),i.setSiblingIndex(0),i.addComponent(c).setContentSize(n,e);var a=i.addComponent(v);a.fillColor=new u(20,24,35,245),a.roundRect(-375,-110,n,e,15),a.fill(),a.strokeColor=new u(255,215,0,150),a.lineWidth=3,a.moveTo(-375,110),a.lineTo(375,110),a.stroke();var r=new l("LeftArea");t.addChild(r),r.setPosition(p(-340,0,0));var d=r.addComponent(v);d.fillColor=new u(0,0,0,100),d.roundRect(-20,-80,40,160,10),d.fill();var s=this.createLabel("ShopTitleText","商\n店",24,new u(255,220,100));r.addChild(s);var m=s.getComponent(C);m.lineHeight=30,m.enableOutline=!0,m.outlineColor=new u(50,30,0,255),m.outlineWidth=2;var f=this.createLabel("DragHintText","拖\n拽\n放\n置",14,new u(180,180,180,200));r.addChild(f),f.setPosition(p(35,0,0));var w=f.getComponent(C);w.lineHeight=18,w.enableOutline=!0,w.outlineColor=new u(0,0,0,150),w.outlineWidth=1;var S=this.createStyledButton("ToggleButton","▼",60,30,18);t.addChild(S),S.setPosition(p(0,125,0));var L=new l("CardContainer");t.addChild(L),L.setPosition(p(-15,-5,0)),L.addComponent(c).setContentSize(560,180);var T=this.createRefreshButton("RefreshButton","刷新",80,80);t.addChild(T),T.setPosition(p(315,0,0)),console.log("UIBuilder: 商店UI创建完成");var P=this.canvas.getComponent(b)||this.canvas.addComponent(b);P.shopPanel=t,P.cardContainer=L,P.cardPrefab=null,P.refreshButton=T.getComponent(g),P.toggleButton=S.getComponent(g),P.refreshCostLabel=null,P.expandedHeight=e,P.collapsedHeight=10;var R=this.canvas.getComponent(B)||this.canvas.getComponentInChildren(B);R||(console.log("UIBuilder: WaveSystem未找到，自动添加到Canvas"),R=this.canvas.addComponent(B)),P.waveSystem=R;var U=this.canvas.getComponent(I)||this.canvas.addComponent(I),z=this.canvas.getComponentInChildren(A);z&&z.towerPrefab&&(U.towerPrefab=z.towerPrefab),this.scheduleOnce((function(){P&&P.refreshShop&&P.refreshShop()}),.1)},a.createRefreshButton=function(e,n,t,o){var i=new l(e);i.addComponent(c).setContentSize(t,o);var a=i.addComponent(v);a.fillColor=new u(60,70,100,255),a.circle(0,0,t/2),a.fill(),a.strokeColor=new u(100,120,160,255),a.lineWidth=3,a.circle(0,0,t/2),a.stroke();var r=this.createLabel("Icon","🔄",28,u.WHITE);i.addChild(r),r.setPosition(p(0,15,0));var d=this.createLabel("CostLabel","剩余2次",11,new u(200,200,200));i.addChild(d),d.setPosition(p(0,-8,0));var s=this.createLabel("HintLabel","每波重置",9,new u(150,150,150,180));return i.addChild(s),s.setPosition(p(0,-22,0)),i.addComponent(g),i},a.createShopCardPrefab=function(){var e=new l("ShopCard");e.addComponent(c).setContentSize(130,180);var n=new l("CardBackground");e.addChild(n),n.addComponent(c).setContentSize(130,180);var t=n.addComponent(v);t.fillColor=new u(30,30,40,255),t.roundRect(-65,-90,130,180,8),t.fill();var o=new l("CardBorder");e.addChild(o);var i=o.addComponent(v);i.strokeColor=u.WHITE,i.lineWidth=3,i.roundRect(-65,-90,130,180,8),i.stroke();var a=new l("ImgBg");e.addChild(a),a.setPosition(p(0,20,0));var r=a.addComponent(v);r.fillColor=new u(20,20,25,255),r.roundRect(-55,-55,110,110,4),r.fill();var d=new l("TowerIcon");e.addChild(d),d.setPosition(p(0,20,0));d.addComponent(m);d.addComponent(c).setContentSize(80,80);var s=this.createLabel("NameLabel","防御塔",16,u.WHITE);e.addChild(s),s.setPosition(p(0,-45,0));var h=s.getComponent(C);h.enableOutline=!0,h.outlineWidth=1;var g=new l("PriceArea");e.addChild(g),g.setPosition(p(0,-70,0));var f=g.addComponent(v);f.fillColor=new u(0,0,0,150),f.roundRect(-40,-12,80,24,12),f.fill();var w=this.createLabel("CostLabel","30",16,new u(255,215,0));g.addChild(w),w.setPosition(p(0,0,0));var b=this.createLabel("DescLabel","",10,u.GRAY);e.addChild(b),b.active=!1;var I=new l("PurchasedMask");e.addChild(I),I.active=!1;var A=I.addComponent(v);A.fillColor=new u(0,0,0,180),A.roundRect(-65,-90,130,180,8),A.fill();var B=this.createLabel("SoldText","已拥有",24,u.RED);return I.addChild(B),e},a.createCancelArea=function(){var e=new l("CancelArea");this.canvas.addChild(e),e.addComponent(c).setContentSize(120,120);var n=e.addComponent(h);n.isAlignTop=!0,n.top=-150,n.isAlignRight=!0,n.right=15;var t=new l("Background");e.addChild(t),t.setSiblingIndex(0),t.addComponent(c).setContentSize(120,120);var o=t.addComponent(h);o.isAlignTop=!0,o.isAlignBottom=!0,o.isAlignLeft=!0,o.isAlignRight=!0,o.top=0,o.bottom=0,o.left=0,o.right=0,o.alignMode=h.AlignMode.ALWAYS;var i=t.addComponent(m);i.type=m.Type.SIMPLE,i.color=new u(255,100,100,100);var a=this.createLabel("CancelLabel","取消",20,new u(255,255,255));e.addChild(a);var r=a.addComponent(h);r.isAlignTop=!0,r.isAlignBottom=!0,r.isAlignLeft=!0,r.isAlignRight=!0;var d=this.canvas.getComponent(I)||this.canvas.addComponent(I);if(d.cancelArea=e,!d.towerPrefab){var s=this.canvas.getComponentInChildren(A);s&&s.towerPrefab&&(d.towerPrefab=s.towerPrefab)}},a.createGameOverUI=function(){var e=this,n=new l("GameOverPanel");this.canvas.addChild(n),n.active=!1,n.setSiblingIndex(99999),n.addComponent(c).setContentSize(750,1334);var t=n.addComponent(h);t.isAlignTop=!0,t.isAlignBottom=!0,t.isAlignLeft=!0,t.isAlignRight=!0,t.top=0,t.bottom=0,t.left=0,t.right=0,t.alignMode=h.AlignMode.ALWAYS;var o=new l("Mask");n.addChild(o),o.addComponent(c).setContentSize(750,1334);var i=o.addComponent(h);i.isAlignTop=!0,i.isAlignBottom=!0,i.isAlignLeft=!0,i.isAlignRight=!0,i.top=0,i.bottom=0,i.left=0,i.right=0,i.alignMode=h.AlignMode.ALWAYS;var a=o.addComponent(v);a.fillColor=new u(0,0,0,200),a.rect(-375,-667,750,1334),a.fill();var r=new l("Banner");n.addChild(r),r.addComponent(c).setContentSize(420,180),r.setPosition(p(0,50,0));var d=r.addComponent(v);d.fillColor=new u(25,22,40,250),d.roundRect(-210,-90,420,180,12),d.fill(),d.strokeColor=new u(180,150,80,255),d.lineWidth=3,d.roundRect(-210,-90,420,180,12),d.stroke(),d.strokeColor=new u(255,220,150,50),d.lineWidth=1,d.roundRect(-206,-86,412,172,10),d.stroke();var s=new l("FailText");r.addChild(s),s.setPosition(p(0,40,0)),s.addComponent(c).setContentSize(400,60);var m=s.addComponent(C);m.string="💀 挑战失败",m.fontSize=38,m.color=new u(255,90,90),m.horizontalAlign=C.HorizontalAlign.CENTER,m.verticalAlign=C.VerticalAlign.CENTER,m.enableOutline=!0,m.outlineColor=new u(60,0,0,200),m.outlineWidth=2;var w=new l("HintText");r.addChild(w),w.setPosition(p(0,-5,0)),w.addComponent(c).setContentSize(400,30);var b=w.addComponent(C);b.string="基地已被摧毁",b.fontSize=16,b.color=new u(160,160,170),b.horizontalAlign=C.HorizontalAlign.CENTER,b.verticalAlign=C.VerticalAlign.CENTER;var I=new l("ResetButton");r.addChild(I),I.setPosition(p(0,-55,0)),I.addComponent(c).setContentSize(160,44);var B=I.addComponent(v);B.fillColor=new u(50,120,200,255),B.roundRect(-80,-22,160,44,6),B.fill(),B.strokeColor=new u(80,160,255,255),B.lineWidth=2,B.roundRect(-80,-22,160,44,6),B.stroke();var T=new l("Label");I.addChild(T),T.addComponent(c).setContentSize(160,44);var P=T.addComponent(C);P.string="🔄 重新挑战",P.fontSize=20,P.color=new u(255,255,255),P.horizontalAlign=C.HorizontalAlign.CENTER,P.verticalAlign=C.VerticalAlign.CENTER,P.enableOutline=!0,P.outlineColor=new u(20,50,100,200),P.outlineWidth=1;var R=I.addComponent(g);R.transition=g.Transition.SCALE,R.zoomScale=1.1,R.node.on(g.EventType.CLICK,(function(){var n=e.canvas.getComponentInChildren(L);if(!n){var t=[];!function e(n){t.push(n),n.children.forEach((function(n){return e(n)}))}(e.canvas);for(var o=0,i=t;o<i.length;o++){var a=i[o].getComponent(L);if(a){n=a;break}}}n?(n.onResetButtonClick(),console.log("调用 onResetButtonClick 成功")):(console.warn("UIController未找到，直接重新加载场景"),A.money=S.INITIAL_MONEY,A.baseHealth=S.INITIAL_HEALTH,A.isGameOver=!1,f.loadScene(f.getScene().name))}),this)},a.createStyledButton=function(e,n,t,o,i){var a=new l(e);a.addComponent(c).setContentSize(t,o);var r=a.addComponent(v);r.fillColor=new u(22,26,38,255),r.roundRect(-t/2,-o/2,t,o,6),r.fill(),r.strokeColor=new u(200,170,100,255),r.lineWidth=2,r.roundRect(-t/2,-o/2,t,o,6),r.stroke();var d=this.createLabel("Label",n,i,u.WHITE);return a.addChild(d),a.addComponent(g),a},a.createLabel=function(e,n,t,o){var i=new l(e);i.addComponent(c).setContentSize(200,30);var a=i.addComponent(C);return a.string=n,a.fontSize=t,a.color=o,a.isBold=!0,i},a.createButton=function(e,n,t,o){var i=new l(e);i.addComponent(c).setContentSize(100,40),i.addComponent(m).color=o;var a=i.addComponent(g);a.transition=g.Transition.COLOR,a.normalColor=o,a.hoverColor=new u(Math.min(255,o.r+30),Math.min(255,o.g+30),Math.min(255,o.b+30)),a.pressedColor=new u(Math.max(0,o.r-30),Math.max(0,o.g-30),Math.max(0,o.b-30));var r=this.createLabel("Label",n,t,u.WHITE);i.addChild(r);var d=r.addComponent(h);return d.isAlignTop=!0,d.isAlignBottom=!0,d.isAlignLeft=!0,d.isAlignRight=!0,i},n}(w)).prototype,"canvas",[P],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),E=n(y.prototype,"buttonSprite",[R],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),M=n(y.prototype,"cardBgSprite",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),H=n(y.prototype,"panelBgSprite",[z],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),W=y))||W));a._RF.pop()}}}));

System.register("chunks:///_virtual/UIController.ts",["./rollupPluginModLoBabelHelpers.js","cc","./TouchManager.ts","./GameConfig.ts","./LevelManager.ts","./WaveSystem.ts","./ShopSystem.ts","./ShopCard.ts"],(function(e){var n,t,o,a,r,i,l,s,u,c,h,v,g,m,f,p,d,y;return{setters:[function(e){n=e.applyDecoratedDescriptor,t=e.inheritsLoose,o=e.initializerDefineProperty,a=e.assertThisInitialized,r=e.createForOfIteratorHelperLoose},function(e){i=e.cclegacy,l=e._decorator,s=e.Label,u=e.Node,c=e.find,h=e.Color,v=e.Component},function(e){g=e.TouchManager},function(e){m=e.GameConfig},function(e){f=e.LevelManager},function(e){p=e.WaveSystem},function(e){d=e.ShopSystem},function(e){y=e.ShopCard}],execute:function(){var C,b,w,S,L,B,I,T,H,W,M,N,U,E,O;i._RF.push({},"c6a63J3FxhH4IS87k0d1T3X","UIController",void 0);var G=l.ccclass,z=l.property;e("UIController",(C=G("UIController"),b=z(s),w=z(s),S=z(s),L=z(s),B=z(u),I=z(u),C((W=n((H=function(e){function n(){for(var n,t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];return n=e.call.apply(e,[this].concat(r))||this,o(n,"moneyLabel",W,a(n)),o(n,"healthLabel",M,a(n)),o(n,"waveLabel",N,a(n)),o(n,"countdownLabel",U,a(n)),o(n,"resetButton",E,a(n)),o(n,"pendingTowerHint",O,a(n)),n.waveSystem=null,n.isUsingUIBuilder=!1,n}t(n,e);var i=n.prototype;return i.start=function(){var e,n=c("Canvas/TopBar");this.isUsingUIBuilder=null!==n,this.isUsingUIBuilder&&(this.moneyLabel&&this.moneyLabel.node&&(this.moneyLabel.node.active=!1),this.healthLabel&&this.healthLabel.node&&(this.healthLabel.node.active=!1),this.waveLabel&&this.waveLabel.node&&(this.waveLabel.node.active=!1)),this.resetButton&&(this.resetButton.active=!1),this.pendingTowerHint&&(this.pendingTowerHint.active=!1),this.waveSystem=(null==(e=c("Canvas"))?void 0:e.getComponentInChildren(p))||null},i.update=function(){var e=c("Canvas/TopBar");if(e){var n=e.getChildByName("LeftArea"),t=e.getChildByName("CenterArea"),o=e.getChildByName("RightArea"),a=function(e,n){if(!e)return null;var t=e.getChildByName(n);if(t)return t;for(var o,a=r(e.children);!(o=a()).done;){if(t=o.value.getChildByName(n))return t}return null},i=a(n,"MoneyLabel")||e.getChildByName("MoneyLabel");if(i){var l=i.getComponent(s);l&&(l.string=""+g.money)}var u=a(n,"HealthLabel")||e.getChildByName("HealthLabel");if(u){var v=u.getComponent(s);v&&(v.string=""+g.baseHealth)}var m=a(o,"WaveLabel")||e.getChildByName("WaveLabel");if(m){var f=m.getComponent(s);if(f&&this.waveSystem){var p,d=this.waveSystem.getCurrentWave(),y=(null==(p=this.waveSystem.waveConfigs)?void 0:p.length)||30;f.string=d>0?d+" / "+y:"准备"}}var C=a(t,"CountdownLabel")||e.getChildByName("CountdownLabel");if(C&&this.waveSystem){var b=C.getComponent(s);if(b){var w,S=this.waveSystem.getPrepareTimeRemaining(),L=this.waveSystem.getNextWaveRemaining(),B=this.waveSystem.getCurrentWave(),I=(null==(w=this.waveSystem.waveConfigs)?void 0:w.length)||30;S>0?(b.string="⏳ 备战 "+Math.ceil(S)+"s",b.color=new h(120,255,120)):B>=I?(b.string="⚔️ 最终波",b.color=new h(255,100,100)):L>0?(b.string="⏳ 下一波 "+Math.ceil(L)+"s",b.color=new h(255,200,100)):b.string=""}}}else if(!this.isUsingUIBuilder&&(this.moneyLabel&&(this.moneyLabel.string="金币: "+g.money),this.healthLabel&&(this.healthLabel.string="生命: "+g.baseHealth),this.waveLabel&&this.waveSystem)){var T=this.waveSystem.getCurrentWave();this.waveLabel.string=T>0?"第"+T+"波/30波":"备战阶段"}g.baseHealth<=0&&!g.isGameOver&&(g.isGameOver=!0,this.showResetMenu())},i.showResetMenu=function(){var e=c("Canvas/GameOverPanel");e?(e.active=!0,e.setSiblingIndex(99999),console.log("显示游戏结束面板 (UIBuilder)"),this.resetButton&&(this.resetButton.active=!1)):this.resetButton?(this.resetButton.active=!0,console.log("显示重置按钮 (旧UI)")):console.warn("GameOverPanel和resetButton都未找到")},i.onResetButtonClick=function(){var e;console.log("点击重新挑战按钮"),this.cleanupGameObjects(),g.money=m.INITIAL_MONEY,g.baseHealth=m.INITIAL_HEALTH,g.isGameOver=!1;var n=c("Canvas/GameOverPanel");n&&(n.active=!1),this.resetButton&&(this.resetButton.active=!1);var t=c("Canvas"),o=null;if(t&&(o=t.getComponent(p),console.log("WaveSystem查找方式1(Canvas直接): "+(o?"找到":"未找到")),o||(o=t.getComponentInChildren(p),console.log("WaveSystem查找方式2(getComponentInChildren): "+(o?"找到":"未找到"))),!o)){var a=[];!function e(n){a.push(n),n.children.forEach((function(n){return e(n)}))}(t);for(var r=0,i=a;r<i.length;r++){var l=i[r],s=l.getComponent(p);if(s){o=s,console.log("WaveSystem查找方式3(手动遍历): 在节点 "+l.name+" 上找到");break}}}o?(o.resetWaveSystem(),console.log("WaveSystem已重置成功")):console.error("未找到WaveSystem组件！请确保WaveSystem已挂载到场景中");var u=null;if(t&&(u=t.getComponent(d),console.log("ShopSystem查找方式1(Canvas直接): "+(u?"找到":"未找到")),u||(u=t.getComponentInChildren(d),console.log("ShopSystem查找方式2(getComponentInChildren): "+(u?"找到":"未找到"))),!u)){var h=[];!function e(n){h.push(n),n.children.forEach((function(n){return e(n)}))}(t);for(var v=0,C=h;v<C.length;v++){var b=C[v],w=b.getComponent(d);if(w){u=w,console.log("ShopSystem查找方式3(手动遍历): 在节点 "+b.name+" 上找到");break}}}if(u){u.resetShop();var S=u;this.scheduleOnce((function(){var e=S.currentCards;e&&e.length>0&&e.forEach((function(e){var n,t=null==(n=e.node)?void 0:n.getComponent(y);t&&t.loadTowerIcon()})),console.log("商店卡片贴图已重新加载")}),.1),console.log("ShopSystem已完全重置成功")}else console.error("未找到ShopSystem组件！请确保ShopSystem已挂载到场景中");var L=null==(e=c("Canvas"))?void 0:e.getComponent(f);L?L.reloadCurrentLevel():console.log("LevelManager不存在，使用简单重置"),console.log("游戏已重置，准备重新开始")},i.cleanupGameObjects=function(){var e=c("Canvas");if(e){console.log("开始清理所有游戏对象");var n=[];!function e(t){n.push(t),t.children.forEach((function(n){return e(n)}))}(e);var t=n.filter((function(e){return null!==e.getComponent("Enemy")||"Enemy"===e.name||e.name.includes("Enemy")}));t.forEach((function(e){e.isValid&&e.destroy()})),console.log("清理了 "+t.length+" 个敌人");var o=n.filter((function(e){return null!==e.getComponent("Bullet")||e.name.includes("Bullet")}));o.forEach((function(e){e.isValid&&e.destroy()})),console.log("清理了 "+o.length+" 个子弹");var a=n.filter((function(e){return null!==e.getComponent("Tower")||"Tower_Instance"===e.name||e.name.includes("Tower")||"DragPreview"===e.name}));a.forEach((function(e){e.isValid&&e.destroy()})),console.log("清理了 "+a.length+" 个防御塔");var r=c("Canvas/GridMap");r&&(r.children.forEach((function(e){var n=e.getComponent("TileSlot");n&&(n.isOccupied=!1)})),console.log("所有格子占用状态已重置")),console.log("游戏对象清理完成")}},n}(v)).prototype,"moneyLabel",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),M=n(H.prototype,"healthLabel",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),N=n(H.prototype,"waveLabel",[S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),U=n(H.prototype,"countdownLabel",[L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),E=n(H.prototype,"resetButton",[B],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),O=n(H.prototype,"pendingTowerHint",[I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),T=H))||T));i._RF.pop()}}}));

System.register("chunks:///_virtual/WaveSystem.ts",["./rollupPluginModLoBabelHelpers.js","cc","./TileSlot.ts","./Enemy.ts","./TouchManager.ts","./ShopSystem.ts","./GameConfig.ts"],(function(e){var t,n,i,a,r,s,o,l,h,u,v,c,p,m,f,y,w,g,T,d;return{setters:[function(e){t=e.applyDecoratedDescriptor,n=e.inheritsLoose,i=e.initializerDefineProperty,a=e.assertThisInitialized,r=e.createForOfIteratorHelperLoose},function(e){s=e.cclegacy,o=e._decorator,l=e.Prefab,h=e.Label,u=e.find,v=e.Color,c=e.instantiate,p=e.Component},function(e){m=e.TileSlot,f=e.TileType},function(e){y=e.EnemyType,w=e.Enemy},function(e){g=e.TouchManager},function(e){T=e.ShopSystem},function(e){d=e.GameConfig}],execute:function(){var b,L,E,C,W,S,A,P,N,M,R,O,B;s._RF.push({},"40a74Nu3FNFnJlyUdOmLjFf","WaveSystem",void 0);var F=o.ccclass,G=o.property;e("WaveSystem",(b=F("WaveSystem"),L=G(l),E=G(l),C=G(l),W=G(h),S=G(h),b((N=t((P=function(e){function t(){for(var t,n=arguments.length,r=new Array(n),s=0;s<n;s++)r[s]=arguments[s];return t=e.call.apply(e,[this].concat(r))||this,i(t,"enemyPrefab",N,a(t)),i(t,"eliteEnemyPrefab",M,a(t)),i(t,"bossEnemyPrefab",R,a(t)),i(t,"waveLabel",O,a(t)),i(t,"countdownLabel",B,a(t)),t.TOTAL_WAVES=30,t.ELITE_WAVES=[15,25],t.BOSS_WAVE=30,t.currentWave=0,t.waveConfigs=[],t.enemiesLeftToSpawn=0,t.spawnTimer=0,t.waveGapTimer=0,t.prepareTimer=d.PREPARE_TIME,t.isPreparing=!0,t.waveElapsedTime=0,t.waveTotalDuration=0,t.canvas=null,t.gridMap=null,t.shopSystem=null,t.enemySpawnCounter=0,t}n(t,e);var s=t.prototype;return s.start=function(){var e,t,n=this;console.log("=== WaveSystem start() 被调用 ==="),this.canvas=u("Canvas"),this.gridMap=u("Canvas/GridMap"),this.shopSystem=(null==(e=u("Canvas"))?void 0:e.getComponentInChildren(T))||null,this.enemyPrefab?console.log("WaveSystem: enemyPrefab已设置"):console.error("WaveSystem: enemyPrefab未设置！请在编辑器中将敌人预制体拖到WaveSystem组件的Enemy Prefab属性中");var i=null==(t=this.canvas)?void 0:t.getComponent("EnemySpawner");i&&(console.log("禁用旧的EnemySpawner组件"),i.enabled=!1),this.initWaveConfigs(),this.scheduleOnce((function(){n.tryFindCountdownLabel()}),.3),this.startPreparePhase(),console.log("=== WaveSystem 初始化完成 ===")},s.tryFindCountdownLabel=function(){if(!this.countdownLabel){var e=u("Canvas/TopBar");if(e){var t=e.getChildByName("CenterArea"),n=(null==t?void 0:t.getChildByName("CountdownLabel"))||e.getChildByName("CountdownLabel");if(n){var i=n.getComponent(h);i&&(this.countdownLabel=i,console.log("WaveSystem: 倒计时标签已连接"))}}}},s.startPreparePhase=function(){console.log("开始备战阶段，倒计时15秒"),this.isPreparing=!0,this.prepareTimer=d.PREPARE_TIME,this.currentWave=0,this.updateWaveLabel(),this.countdownLabel&&(this.countdownLabel.string="准备时间: "+Math.ceil(this.prepareTimer)+"秒")},s.resetWaveSystem=function(){console.log("完全重置WaveSystem..."),this.currentWave=0,this.isPreparing=!0,this.prepareTimer=d.PREPARE_TIME,this.enemiesLeftToSpawn=0,this.spawnTimer=0,this.waveGapTimer=0,this.waveElapsedTime=0,this.waveTotalDuration=0,this.initWaveConfigs(),this.startPreparePhase(),console.log("WaveSystem已完全重置，从备战阶段开始")},s.updateWaveLabel=function(){var e=this.currentWave>0?this.currentWave+"/30":"准备",t=u("Canvas/TopBar");if(t){var n=null,i=t.getChildByName("RightArea");if(i){var a,s=i.getChildByName("WaveBg");if(s)n=(null==(a=s.getChildByName("WaveLabel"))?void 0:a.getComponent(h))||null}if(!n){n=function e(t){if("WaveLabel"===t.name)return t.getComponent(h);for(var n,i=r(t.children);!(n=i()).done;){var a=e(n.value);if(a)return a}return null}(t)}n&&(n.string=e)}this.waveLabel&&(this.waveLabel.string=e)},s.initWaveConfigs=function(){this.waveConfigs=[];for(var e=1;e<=this.TOTAL_WAVES;e++){var t=this.ELITE_WAVES.includes(e),n=e===this.BOSS_WAVE,i=void 0,a=void 0,r=void 0;n?(i=1,a=0,r=y.BOSS):t?(i=8,a=1,r=y.ELITE):(i=this.getEnemyCountForWave(e),a=d.ENEMY_SPAWN_INTERVAL,r=this.getEnemyTypeForWave(e)),this.waveConfigs.push({waveNumber:e,enemyCount:i,enemyType:r,spawnInterval:a,isElite:t,isBoss:n})}console.log("波次配置初始化完成，共30波");for(var s=0;s<Math.min(5,this.waveConfigs.length);s++){var o=this.waveConfigs[s],l=this.getEnemyTypeName(o.enemyType);console.log("第"+o.waveNumber+"波: "+o.enemyCount+"个"+l+"敌人, 间隔"+o.spawnInterval.toFixed(2)+"秒")}},s.getEnemyTypeName=function(e){switch(e){case y.NORMAL:return"普通";case y.FAST:return"快速";case y.TANK:return"坦克";case y.ELITE:return"精英";case y.BOSS:return"Boss";default:return"未知"}},s.getEnemyCountForWave=function(e){return{1:30,2:30,3:32,4:35,5:35,6:32,7:32,8:38,9:38,10:36,11:34,12:34,13:40,14:40,16:38,17:35,18:35,19:42,20:40,21:40,22:42,23:44,24:45,26:42,27:44,28:45,29:35}[e]||35},s.getEnemyTypeForWave=function(e){return{1:y.NORMAL,2:y.NORMAL,3:y.NORMAL,4:y.FAST,5:y.FAST,6:y.NORMAL,7:y.NORMAL,8:y.TANK,9:y.TANK,10:y.FAST,11:y.NORMAL,12:y.NORMAL,13:y.TANK,14:y.TANK,16:y.FAST,17:y.NORMAL,18:y.NORMAL,19:y.TANK,20:y.FAST,21:y.FAST,22:y.TANK,23:y.TANK,24:y.TANK,26:y.FAST,27:y.TANK,28:y.TANK,29:y.NORMAL}[e]||y.NORMAL},s.startWave=function(e){var t=this;if(e>this.TOTAL_WAVES)console.log("恭喜！所有波次完成！");else{this.currentWave=e,this.isPreparing=!1;var n=this.waveConfigs[e-1];if(n){var i=n.enemyType===y.NORMAL?"普通":n.enemyType===y.FAST?"快速":"坦克";console.log("=== 开始第"+e+"波: "+n.enemyCount+"个"+i+"敌人 ==="),this.enemiesLeftToSpawn=n.enemyCount,this.spawnTimer=0,this.waveGapTimer=0,this.waveElapsedTime=0,this.enemySpawnCounter=0,n.isBoss?this.waveTotalDuration=45:n.isElite?this.waveTotalDuration=35:this.waveTotalDuration=25,this.updateWaveLabel(),this.scheduleOnce((function(){t.updateWaveLabel()}),.1),this.shopSystem&&this.shopSystem.refreshShop()}else console.error("波次配置不存在: "+e)}},s.update=function(e){if(!g.isGameOver)if(!this.countdownLabel&&this.node.frameCount<10&&this.tryFindCountdownLabel(),this.isPreparing){if(this.prepareTimer-=e,this.updateWaveLabel(),this.countdownLabel&&this.countdownLabel.isValid){var t=Math.ceil(Math.max(0,this.prepareTimer));this.countdownLabel.string="⏳ 准备时间: "+t+"秒",this.countdownLabel.color=new v(255,200,100,255)}this.prepareTimer<=0&&(console.log("备战阶段结束，开始第1波"),this.startWave(1))}else{this.updateWaveLabel();var n=this.waveConfigs[this.currentWave-1];if(n)if(this.waveElapsedTime+=e,this.enemiesLeftToSpawn>0)this.spawnTimer+=e,this.spawnTimer>=n.spawnInterval&&(this.enemyPrefab?(this.spawnEnemy(n),console.log("生成敌人: 第"+this.currentWave+"波，剩余: "+(this.enemiesLeftToSpawn-1)+"/"+n.enemyCount)):console.error("无法生成敌人：enemyPrefab未设置！"),this.enemiesLeftToSpawn--,this.spawnTimer=0),this.waveGapTimer=0,this.countdownLabel&&this.countdownLabel.isValid&&(this.countdownLabel.string="");else{this.canvas||(this.canvas=u("Canvas"));var i=this.canvas?function e(t){var n=[];return"Enemy"===t.name&&t.isValid&&n.push(t),t.children.forEach((function(t){n.push.apply(n,e(t))})),n}(this.canvas):[];if(0===i.length){var a=n.isBoss?6:n.isElite?5:4;0===this.waveGapTimer?(console.log("[第"+this.currentWave+"波] 所有敌人被消灭，开始倒计时 "+a+"秒"),this.waveGapTimer=e):this.waveGapTimer+=e;var r=a-this.waveGapTimer;if(this.countdownLabel&&this.countdownLabel.isValid)this.countdownLabel.string=r>0?"下一波: "+Math.ceil(r)+"秒":"";else{var s=u("Canvas/TopBar");if(s){var o=s.getChildByName("CountdownLabel");if(o){var l=o.getComponent(h);l&&r>0&&(l.string="下一波: "+Math.ceil(r)+"秒")}}}if(this.waveGapTimer>=a){var c=this.currentWave+1;return console.log("[第"+this.currentWave+"波] 倒计时结束，开始第"+c+"波"),void this.startWave(c)}}else this.waveGapTimer>0&&console.log("[第"+this.currentWave+"波] 还有"+i.length+"个敌人存活，重置倒计时"),this.waveGapTimer=0,this.countdownLabel&&this.countdownLabel.isValid&&(this.countdownLabel.string="")}else console.warn("当前波次配置不存在: currentWave="+this.currentWave+", waveConfigs.length="+this.waveConfigs.length)}},s.spawnEnemy=function(e){if(this.enemyPrefab)if(this.gridMap||(this.gridMap=u("Canvas/GridMap")),this.gridMap){var t=this.gridMap.children.find((function(e){var t=e.getComponent(m);return t&&t.type===f.START}));if(t){var n=e.enemyType,i=this.enemyPrefab;e.isBoss&&this.bossEnemyPrefab?i=this.bossEnemyPrefab:e.isElite&&this.eliteEnemyPrefab&&(i=this.eliteEnemyPrefab);var a=c(i);if(this.canvas||(this.canvas=u("Canvas")),this.canvas){this.canvas.addChild(a),a.name="Enemy",a.setPosition(t.getPosition());var r=a.getComponent(w);if(r){r.init(this.currentWave,n),this.enemySpawnCounter++,r.setSpawnOrder(this.enemySpawnCounter);var s=this.getEnemyTypeName(n);console.log("生成敌人: "+s+", 波次: "+this.currentWave+", 血量: "+r.maxHp+", 速度: "+r.speed)}else console.error("spawnEnemy: Enemy组件未找到")}else a.destroy()}else console.warn("spawnEnemy: 未找到START类型的格子")}else console.warn("spawnEnemy: GridMap未找到");else console.error("spawnEnemy: enemyPrefab未设置")},s.getCurrentWave=function(){return this.currentWave},s.isInPreparePhase=function(){return this.isPreparing},s.getPrepareTimeRemaining=function(){return this.isPreparing?Math.max(0,this.prepareTimer):0},s.getNextWaveRemaining=function(){if(this.isPreparing)return 0;if(this.currentWave<=0)return 0;if(this.currentWave>=this.waveConfigs.length)return 0;var e=this.waveConfigs[this.currentWave-1],t=null!=e&&e.isBoss?6:null!=e&&e.isElite?5:4;if(this.waveGapTimer>0)return Math.max(0,t-this.waveGapTimer);var n=this.waveTotalDuration-this.waveElapsedTime;return n<=0?t:n},s.getWaveGapRemaining=function(){if(this.waveGapTimer<=0)return 0;var e=this.waveConfigs[this.currentWave-1];if(!e)return 0;var t=e.isBoss?6:e.isElite?5:4;return Math.max(0,t-this.waveGapTimer)},s.isInCombat=function(){return!this.isPreparing&&(!(this.waveGapTimer>0)&&this.currentWave>0)},t}(p)).prototype,"enemyPrefab",[L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),M=t(P.prototype,"eliteEnemyPrefab",[E],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),R=t(P.prototype,"bossEnemyPrefab",[C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),O=t(P.prototype,"waveLabel",[W],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),B=t(P.prototype,"countdownLabel",[S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),A=P))||A));s._RF.pop()}}}));

(function(r) {
  r('virtual:///prerequisite-imports/main', 'chunks:///_virtual/main'); 
})(function(mid, cid) {
    System.register(mid, [cid], function (_export, _context) {
    return {
        setters: [function(_m) {
            var _exportObj = {};

            for (var _key in _m) {
              if (_key !== "default" && _key !== "__esModule") _exportObj[_key] = _m[_key];
            }
      
            _export(_exportObj);
        }],
        execute: function () { }
    };
    });
});